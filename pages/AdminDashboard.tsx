
import React, { useEffect, useState, useRef } from 'react';
import { 
    getLeads, getAffiliates, getUsers, getJobs, saveJob, updateJob, deleteJob, 
    getBlogPosts, saveBlogPost, updateBlogPost, deleteBlogPost, 
    updateAffiliateStatus,
    getJobInterests, getEcosystemApplications, updateEcosystemAppStatus, updateEcosystemStudent,
    getCommunityMembers, saveCommunityMember, deleteCommunityMember, bulkSaveCommunityMembers,
    updateData, deleteUserDoc,
    updateBatchClassDetails, sendBatchNotice, saveClassSession, updateClassSession, getClassSessions, deleteClassSession, bulkSaveJobs,
    updateUserProfile, deleteData, globalSearchSystem,
    getNoticesHistory, updateNoticeHistory, saveResource, updateResource, getResources, deleteResource,
    getWithdrawalRequests, updateWithdrawalStatus, saveAmbassadorTask, getAmbassadorTasks, deleteAmbassadorTask,
    completeAmbassadorTenure, saveCommunityMeeting, getCommunityMeetings, deleteCommunityMeeting, updateCommunityMeeting,
    deleteLead, deleteJobInterest
} from '../services/firebase';
import { uploadFileToDrive } from '../services/googleDriveService';
import { User, Lead, Affiliate, Job, BlogPost, JobInterest, EcosystemApplication, CommunityMember, ClassSession, AmbassadorTask, CommunityMeeting, WithdrawalRequest } from '../types';
import { useNavigate } from 'react-router-dom';
import { 
    LayoutDashboard, Briefcase, BookOpen, 
    Trash2, X, Search, Edit, CheckCircle, Database, Filter, UserPlus, FileSpreadsheet, Award, Layers, Calendar, Video, Eye, Printer, Building, Users, Share2, TrendingUp, CheckSquare, Plus, ExternalLink, Megaphone, Box, GraduationCap, BookOpenCheck, DollarSign, AlertCircle, Home, FileText, Link as LinkIcon, Clock, MapPin, Upload, Sparkles, UserPlus as AddUser, UserCog, Activity, File
} from 'lucide-react';
import { GoogleGenAI } from "@google/genai";

interface AdminDashboardProps {
    user: User | null;
}

const AdminDashboard: React.FC<AdminDashboardProps> = ({ user }) => {
    const ADMIN_EMAILS = ['onewayschool.bd@gmail.com', 'onewayschool.bd@gamil.com', 'admin@ows.com']; 
    const navigate = useNavigate();

    // --- Tab States ---
    const [activeTab, setActiveTab] = useState<'overview' | 'ecosystem' | 'community' | 'jobs' | 'blogs' | 'database' | 'users' | 'instructors'>('overview');
    
    // --- Sub-Tab States ---
    const [ecoSubTab, setEcoSubTab] = useState<'list' | 'batch' | 'routine' | 'attendance' | 'notice' | 'cv_resource'>('list');
    const [communitySubTab, setCommunitySubTab] = useState<'affiliate' | 'ambassador' | 'task' | 'meeting'>('affiliate');
    const [comListFilter, setComListFilter] = useState<'active' | 'pending'>('active');
    const [databaseTab, setDatabaseTab] = useState<'leads' | 'interests' | 'community_db'>('leads');
    const [communityDbFilter, setCommunityDbFilter] = useState('All'); 

    // --- Data Loading & Search ---
    const [loading, setLoading] = useState(false);
    const [globalSearch, setGlobalSearch] = useState('');
    const [localSearch, setLocalSearch] = useState(''); // Per Tab Search
    const [searchResults, setSearchResults] = useState<any[]>([]);
    
    // --- Overview States ---
    const [overviewDate, setOverviewDate] = useState(new Date().toISOString().split('T')[0]);

    // --- Core Data ---
    const [usersList, setUsersList] = useState<User[]>([]);
    const [leads, setLeads] = useState<Lead[]>([]);
    const [jobs, setJobs] = useState<Job[]>([]);
    const [blogs, setBlogs] = useState<BlogPost[]>([]);
    const [jobInterests, setJobInterests] = useState<JobInterest[]>([]);
    const [ecosystemApps, setEcosystemApps] = useState<EcosystemApplication[]>([]);
    const [affiliates, setAffiliates] = useState<Affiliate[]>([]);
    const [communityMembers, setCommunityMembers] = useState<CommunityMember[]>([]);
    const [classSessions, setClassSessions] = useState<ClassSession[]>([]);
    
    const [noticesHistory, setNoticesHistory] = useState<any[]>([]);
    const [resourcesList, setResourcesList] = useState<any[]>([]);
    const [withdrawals, setWithdrawals] = useState<WithdrawalRequest[]>([]);
    const [ambassadorTasks, setAmbassadorTasks] = useState<AmbassadorTask[]>([]);
    const [communityMeetings, setCommunityMeetings] = useState<CommunityMeeting[]>([]);

    // --- Filtering State ---
    const [filterBatch, setFilterBatch] = useState('All');
    const [routineFilterBatch, setRoutineFilterBatch] = useState('All'); 
    const [filterStatus, setFilterStatus] = useState('All');
    const [filterDate, setFilterDate] = useState('');
    const [selectedIds, setSelectedIds] = useState<string[]>([]);

    // --- Forms & Modal State ---
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [modalType, setModalType] = useState<string | null>(null);
    const [formLoading, setFormLoading] = useState(false);
    const [uploadingPhoto, setUploadingPhoto] = useState(false);

    // Edit States
    const [editingSessionId, setEditingSessionId] = useState<string | null>(null);
    const [editingResourceId, setEditingResourceId] = useState<string | null>(null);
    const [editingNoticeId, setEditingNoticeId] = useState<string | null>(null);
    const [editingBlogId, setEditingBlogId] = useState<string | null>(null);
    const [editingJobId, setEditingJobId] = useState<string | null>(null);
    
    // Viewer Logic
    const [viewingJobInterests, setViewingJobInterests] = useState<string | null>(null);
    const [studentForHistory, setStudentForHistory] = useState<EcosystemApplication | null>(null);

    // Dynamic Form Objects
    const [newJob, setNewJob] = useState<Job>({ title: '', company: '', location: '', salary: '', employmentStatus: 'Full-time' });
    const [rawJobText, setRawJobText] = useState(''); // For AI Parsing
    const [newBlog, setNewBlog] = useState<BlogPost>({ title: '', excerpt: '', author: 'Admin', imageUrl: '', content: '' });
    const [manageStudent, setManageStudent] = useState<EcosystemApplication | null>(null);
    const [studentEditForm, setStudentEditForm] = useState<Partial<EcosystemApplication>>({});
    const [classSessionForm, setClassSessionForm] = useState<ClassSession>({ batch: '', topic: '', mentorName: '', date: '', time: '', link: '' });
    const [noticeForm, setNoticeForm] = useState({ targetBatch: 'All', title: '', message: '' });
    const [resourceForm, setResourceForm] = useState({ title: '', link: '', type: 'PDF' });
    const [newTaskForm, setNewTaskForm] = useState<Partial<AmbassadorTask>>({ type: 'Social Share', status: 'Active', assignedTo: 'All' });
    const [newMeetingForm, setNewMeetingForm] = useState<Partial<CommunityMeeting>>({ platform: 'Google Meet', assignedTo: 'All' });
    const [newMemberForm, setNewMemberForm] = useState<Partial<CommunityMember>>({ role: 'Member', category: 'Volunteer' });
    const [instructorSearch, setInstructorSearch] = useState('');
    
    // Community Member Manage State
    const [selectedMember, setSelectedMember] = useState<Affiliate | null>(null);
    const [memberEditForm, setMemberEditForm] = useState<Partial<Affiliate>>({});

    // DB Member Edit State
    const [selectedDbMember, setSelectedDbMember] = useState<any>(null);
    const [dbMemberEditForm, setDbMemberEditForm] = useState<any>({});

    // Lead Manage State
    const [selectedLead, setSelectedLead] = useState<Lead | null>(null);
    const [leadEditForm, setLeadEditForm] = useState<Partial<Lead>>({});

    // Attendance specific state
    const [attendanceDate, setAttendanceDate] = useState(new Date().toISOString().split('T')[0]);
    const [batchModuleForm, setBatchModuleForm] = useState({ batch: '', moduleId: 1 });

    const MODULES = [
        { id: 1, title: "মডিউল ১: সেলস সাইকোলজি এবং ব্রেইন হ্যাকিং" },
        { id: 2, title: "মডিউল ২: হিপনোটিক কমিউনিকেশন ও ইনফ্লুয়েন্স" },
        { id: 3, title: "মডিউল ৩: এলিট নেটওয়ার্কিং ও পার্সোনাল ব্র্যান্ডিং" },
        { id: 4, title: "মডিউল ৪: কর্পোরেট পলিটিক্স ও ইমোশনাল মাস্টারি" }
    ];
    
    const ADMISSION_FEE = 1500;
    const MODULE_FEE = 2000;

    // Derived Data
    const uniqueBatches = Array.from(new Set(ecosystemApps.map(app => app.batch).filter(Boolean))) as string[];
    const batchStatusList = uniqueBatches.map(batchName => {
        const studentsInBatch = ecosystemApps.filter(s => s.batch === batchName);
        const currentModule = studentsInBatch[0]?.currentModule || 1;
        const studentCount = studentsInBatch.length;
        const currentPhase = studentsInBatch[0]?.currentPhase || 'Learning';
        return { batchName, currentModule, studentCount, currentPhase };
    });

    const overviewData = {
        students: ecosystemApps.filter(item => {
            const date = item.createdAt?.seconds ? new Date(item.createdAt.seconds * 1000) : (item.createdAt ? new Date(item.createdAt) : null);
            return date ? date.toISOString().split('T')[0] === overviewDate : false;
        }),
        jobs: jobs.filter(item => {
            const date = item.postedDate?.seconds ? new Date(item.postedDate.seconds * 1000) : (item.postedDate ? new Date(item.postedDate) : null);
            return date ? date.toISOString().split('T')[0] === overviewDate : false;
        }),
        payments: ecosystemApps.filter(item => {
            const date = item.createdAt?.seconds ? new Date(item.createdAt.seconds * 1000) : (item.createdAt ? new Date(item.createdAt) : null);
            return (date ? date.toISOString().split('T')[0] === overviewDate : false) && item.status === 'approved';
        })
    };

    useEffect(() => {
        if (user && (ADMIN_EMAILS.includes(user.email || '') || user.role === 'admin' || user.role === 'moderator' || user.role === 'super_admin')) {
            fetchData();
        }
    }, [user]);

    // ... (rest of the file content remains same, just replacing the final render block access check)

    const fetchEcosystemSpecifics = async () => {
        try {
            const [cs, nh, rl] = await Promise.all([getClassSessions(), getNoticesHistory(), getResources()]);
            setClassSessions(cs as ClassSession[]);
            setNoticesHistory(nh as any[]);
            setResourcesList(rl as any[]);
        } catch (e) { console.error("Eco fetch error:", e); }
    };

    const fetchCommunitySpecifics = async () => {
        try {
            const [w, t, m] = await Promise.all([getWithdrawalRequests(), getAmbassadorTasks(), getCommunityMeetings()]);
            setWithdrawals(w as WithdrawalRequest[]);
            setAmbassadorTasks(t as AmbassadorTask[]);
            setCommunityMeetings(m as CommunityMeeting[]);
        } catch (e) { console.error("Com fetch error:", e); }
    };

    const fetchData = async () => {
        setLoading(true);
        try {
            const [u, j, b, ji, ea, af, cm, cs, l, nh, rl, w, t, m] = await Promise.all([
                getUsers(), getJobs(), getBlogPosts(), getJobInterests(), 
                getEcosystemApplications(), getAffiliates(), getCommunityMembers(), 
                getClassSessions(),
                getLeads(), getNoticesHistory(), getResources(), getWithdrawalRequests(), getAmbassadorTasks(), getCommunityMeetings()
            ]);
            setUsersList(u as User[]);
            setJobs(j as Job[]);
            setBlogs(b as BlogPost[]);
            setJobInterests(ji as JobInterest[]);
            setEcosystemApps(ea as EcosystemApplication[]);
            setAffiliates(af as Affiliate[]);
            setCommunityMembers(cm as CommunityMember[]); 
            setClassSessions(cs as ClassSession[]);
            setLeads(l as Lead[]);
            setNoticesHistory(nh as any[]);
            setResourcesList(rl as any[]);
            setWithdrawals(w as WithdrawalRequest[]);
            setAmbassadorTasks(t as AmbassadorTask[]);
            setCommunityMeetings(m as CommunityMeeting[]);
        } catch (error) { console.error("Data fetch error:", error); }
        setLoading(false);
    };

    useEffect(() => {
        if (user && activeTab === 'ecosystem') fetchEcosystemSpecifics();
        if (user && activeTab === 'community') fetchCommunitySpecifics();
        setLocalSearch(''); 
    }, [activeTab, ecoSubTab, communitySubTab, user]);

    useEffect(() => {
        const delaySearch = setTimeout(async () => {
            if (globalSearch.length > 2) {
                setLoading(true);
                const results = await globalSearchSystem(globalSearch);
                setSearchResults(results);
                setLoading(false);
            } else {
                setSearchResults([]);
            }
        }, 500);
        return () => clearTimeout(delaySearch);
    }, [globalSearch]);

    // ... (All other helper functions and renders remain exactly as they were, omitting to save space as per instructions unless modified) ...
    // Just providing the full file content with the access check modification at the end.

    const handlePhotoUpload = async (e: React.ChangeEvent<HTMLInputElement>, setter: React.Dispatch<React.SetStateAction<any>>, field: string, currentState: any) => {
        const file = e.target.files?.[0];
        if (!file) return;
        setUploadingPhoto(true);
        try {
            const url = await uploadFileToDrive(file);
            setter({ ...currentState, [field]: url });
        } catch (err) {
            console.error(err);
            alert("Error uploading photo");
        }
        setUploadingPhoto(false);
    };

    const filterData = (data: any[], keys: string[]) => {
        if (!localSearch) return data;
        return data.filter(item => 
            keys.some(key => item[key]?.toString().toLowerCase().includes(localSearch.toLowerCase()))
        );
    };

    const getStats = () => [
        { label: 'Students', count: ecosystemApps.length, icon: GraduationCap, color: 'text-blue-600', bg: 'bg-blue-50' },
        { label: 'Jobs Posted', count: jobs.length, icon: Briefcase, color: 'text-purple-600', bg: 'bg-purple-50' },
        { label: 'Blogs', count: blogs.length, icon: BookOpen, color: 'text-pink-600', bg: 'bg-pink-50' },
        { label: 'Instructors', count: usersList.filter(u=>u.role==='instructor').length, icon: UserCog, color: 'text-orange-600', bg: 'bg-orange-50' },
        { label: 'Community', count: affiliates.length + communityMembers.length, icon: Users, color: 'text-green-600', bg: 'bg-green-50' },
    ];

    const getRecentActivityList = () => {
        const activities: any[] = [];
        const addAct = (list: any[], type: string, titleKey: string, dateKey: string = 'createdAt', color: string = 'blue') => {
            list.forEach(item => {
                let date = item[dateKey];
                if (date && date.seconds) date = new Date(date.seconds * 1000);
                else if (date) date = new Date(date);
                if (date) {
                    activities.push({ type, title: item[titleKey] || 'Untitled', date, color, id: item.id });
                }
            });
        };
        addAct(ecosystemApps, 'Ecosystem', 'name', 'createdAt', 'blue');
        addAct(jobs, 'Job', 'title', 'postedDate', 'purple');
        addAct(blogs, 'Blog', 'title', 'date', 'pink');
        addAct(affiliates, 'Community', 'name', 'createdAt', 'green');
        addAct(leads, 'Database', 'name', 'createdAt', 'orange');
        return activities.sort((a, b) => b.date.getTime() - a.date.getTime()).slice(0, 15);
    };
    const recentActivities = getRecentActivityList();

    const handlePromoteInstructor = async (userId: string) => {
        if(!window.confirm("Are you sure you want to promote this user to Instructor?")) return;
        await handleGenericSave(updateUserProfile(userId, { role: 'instructor' }), "User Promoted to Instructor!");
    };
    const handleDemoteInstructor = async (userId: string) => {
        if(!window.confirm("Remove Instructor role?")) return;
        await handleGenericSave(updateUserProfile(userId, { role: 'user' }), "Instructor Removed.");
    };
    const calculateFinancials = (module: number = 1, paid: number = 0) => {
        const totalPayable = ADMISSION_FEE + (module * MODULE_FEE);
        const due = totalPayable - paid;
        return { totalPayable, due };
    };
    const handleSelect = (id: string) => {
        if (selectedIds.includes(id)) setSelectedIds(selectedIds.filter(i => i !== id));
        else setSelectedIds([...selectedIds, id]);
    };
    const handleSelectAll = (ids: string[]) => {
        if (selectedIds.length === ids.length) setSelectedIds([]);
        else setSelectedIds(ids);
    };

    const handleGenericSave = async (promise: Promise<any>, successMsg: string) => {
        setFormLoading(true);
        try { 
            await promise; 
            alert(successMsg); 
            setIsModalOpen(false); 
            if (activeTab === 'ecosystem') await fetchEcosystemSpecifics();
            if (activeTab === 'community') await fetchCommunitySpecifics();
            fetchData(); 
        } 
        catch (e) { console.error(e); alert("Action Failed. Check console."); }
        setFormLoading(false);
    };

    // Actions
    const handleAddClass = async (e: React.FormEvent) => { e.preventDefault(); if (editingSessionId) { await handleGenericSave(updateClassSession(editingSessionId, classSessionForm), "Class Updated!"); setEditingSessionId(null); } else { await handleGenericSave(saveClassSession(classSessionForm), "Class Scheduled!"); } setClassSessionForm({ batch: '', topic: '', mentorName: '', date: '', time: '', link: '' }); };
    const handleEditClass = (session: ClassSession) => { setClassSessionForm(session); setEditingSessionId(session.id || null); };
    const cancelEditClass = () => { setEditingSessionId(null); setClassSessionForm({ batch: '', topic: '', mentorName: '', date: '', time: '', link: '' }); };
    const handleUpdateBatchModule = async (e: React.FormEvent) => { e.preventDefault(); if(!batchModuleForm.batch) { alert("Select a batch first."); return; } await handleGenericSave(updateBatchClassDetails(batchModuleForm.batch, { currentModule: Number(batchModuleForm.moduleId) }), `Batch ${batchModuleForm.batch} updated to Module ${batchModuleForm.moduleId}`); };
    const handleSendNotice = async (e: React.FormEvent) => { e.preventDefault(); if (editingNoticeId) { await handleGenericSave(updateNoticeHistory(editingNoticeId, noticeForm), "Notice Record Updated"); setEditingNoticeId(null); } else { await handleGenericSave(sendBatchNotice(noticeForm.targetBatch, { title: noticeForm.title, message: noticeForm.message, date: new Date(), type: 'info' }), "Notice Sent!"); } setNoticeForm({ targetBatch: 'All', title: '', message: '' }); };
    const handleEditNotice = (notice: any) => { setNoticeForm({ targetBatch: notice.targetBatch, title: notice.title, message: notice.message }); setEditingNoticeId(notice.id); };
    const cancelEditNotice = () => { setEditingNoticeId(null); setNoticeForm({ targetBatch: 'All', title: '', message: '' }); };
    const handleAddResource = async (e: React.FormEvent) => { e.preventDefault(); if (editingResourceId) { await handleGenericSave(updateResource(editingResourceId, resourceForm), "Resource Updated!"); setEditingResourceId(null); } else { await handleGenericSave(saveResource(resourceForm), "Resource Uploaded!"); } setResourceForm({ title: '', link: '', type: 'PDF' }); };
    const handleEditResource = (res: any) => { setResourceForm(res); setEditingResourceId(res.id); };
    const cancelEditResource = () => { setEditingResourceId(null); setResourceForm({ title: '', link: '', type: 'PDF' }); };
    const handleAttendance = async (studentId: string, status: 'Present' | 'Absent') => { const dateKey = attendanceDate; const student = ecosystemApps.find(s => s.id === studentId); if(!student) return; const newRecord = { ...(student.attendanceRecord || {}), [dateKey]: status }; const total = Object.keys(newRecord).length; const present = Object.values(newRecord).filter(s => s === 'Present').length; const score = total === 0 ? 0 : Math.round((present/total)*100); try { await updateEcosystemStudent(studentId, { attendanceRecord: newRecord, scores: { ...(student.scores || {}), attendance: score } }); setEcosystemApps(prev => prev.map(s => s.id === studentId ? { ...s, attendanceRecord: newRecord, scores: { ...s.scores, attendance: score } as any } : s)); } catch (e) { alert("Failed to mark attendance."); } };
    const viewAttendanceHistory = (student: EcosystemApplication) => { setStudentForHistory(student); setModalType('attendance_history'); setIsModalOpen(true); };

    const handleApproveAffiliate = async (id: string, name: string) => { if (!window.confirm("Approve this user?")) return; const code = (name.slice(0, 3).toUpperCase() + Math.floor(1000 + Math.random() * 9000)).replace(/\s/g, ''); await handleGenericSave(updateAffiliateStatus(id, 'approved', code), `Affiliate Approved! Code: ${code}`); };
    const handleBulkAction = async (action: 'approve' | 'delete' | 'ban') => { if (selectedIds.length === 0) return; if (!window.confirm(`Are you sure you want to ${action} ${selectedIds.length} items?`)) return; setFormLoading(true); try { for (const id of selectedIds) { if (action === 'approve') { const member = affiliates.find(a => a.id === id); if(member) await handleApproveAffiliate(id, member.name); } else if (action === 'delete') { /* delete */ } else if (action === 'ban') { await updateAffiliateStatus(id, 'banned'); } } alert("Bulk Action Completed"); fetchData(); setSelectedIds([]); } catch (e) { console.error(e); } setFormLoading(false); };
    const handleMarkPaid = async (id: string) => { await handleGenericSave(updateWithdrawalStatus(id, 'paid'), "Marked as Paid"); };
    const handleSaveTask = async (e: React.FormEvent) => { e.preventDefault(); await handleGenericSave(saveAmbassadorTask({...newTaskForm, createdAt: new Date()}), "Task Created"); setNewTaskForm({ type: 'Social Share', status: 'Active', assignedTo: 'All' }); };
    const handleSaveMeeting = async (e: React.FormEvent) => { e.preventDefault(); await handleGenericSave(saveCommunityMeeting({...newMeetingForm, createdAt: new Date()}), "Meeting Scheduled"); setNewMeetingForm({ platform: 'Google Meet', assignedTo: 'All' }); };
    const handleCompleteTenure = async (id: string) => { if (!window.confirm("Are you sure? This will graduate the Ambassador to Alumni status and enable their certificate.")) return; await handleGenericSave(completeAmbassadorTenure(id), "Ambassador Graduated! Certificate Enabled."); };

    const openMemberModal = (member: Affiliate) => { setSelectedMember(member); setMemberEditForm(member); setModalType('manage_member'); setIsModalOpen(true); };

    const handleEditDbMember = (member: any) => {
        setSelectedDbMember(member);
        setDbMemberEditForm({
            name: member.name,
            phone: member.phone,
            email: member.email,
            role: member.role || 'Member',
            category: member.category || 'Volunteer',
            imageUrl: member.imageUrl || member.photoURL || ''
        });
        setModalType('edit_db_member');
        setIsModalOpen(true);
    };

    const handleSaveDbMember = async (e: React.FormEvent) => {
        e.preventDefault();
        if(!selectedDbMember) return;
        const isAffiliateCollection = selectedDbMember.type === 'Affiliate' || selectedDbMember.type === 'Campus Ambassador';
        const collectionName = isAffiliateCollection ? 'affiliates' : 'community_members';
        await handleGenericSave(updateData(collectionName, selectedDbMember.id, dbMemberEditForm), "Member Updated");
    };

    const handleEditLead = (lead: Lead) => { setSelectedLead(lead); setLeadEditForm(lead); setModalType('edit_lead'); setIsModalOpen(true); };
    const exportToCSV = (data: any[], filename: string) => { if (!data || !data.length) return; const headers = Object.keys(data[0]).join(','); const rows = data.map(obj => Object.values(obj).map(v => `"${v}"`).join(',')).join('\n'); const csvContent = "data:text/csv;charset=utf-8," + headers + '\n' + rows; const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `${filename}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
    const handleAddMemberToDb = async (e: React.FormEvent) => { e.preventDefault(); await handleGenericSave(saveCommunityMember({...newMemberForm, createdAt: new Date()}), "Member Added to Database"); setNewMemberForm({ role: 'Member', category: 'Volunteer', name: '', phone: '', email: '' }); };
    const handleBulkImport = (e: React.ChangeEvent<HTMLInputElement>) => { const file = e.target.files?.[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (event) => { try { const text = event.target?.result as string; const rows = text.split('\n').map(r => r.split(',')); const members = []; for (let i = 1; i < rows.length; i++) { const row = rows[i]; if (row.length >= 3) { members.push({ name: row[0]?.trim() || 'Unknown', phone: row[1]?.trim() || '', email: row[2]?.trim() || '', role: row[3]?.trim() || 'Member', category: row[4]?.trim() || communityDbFilter !== 'All' ? communityDbFilter : 'Volunteer' }); } } if (members.length > 0) { if(window.confirm(`Import ${members.length} members?`)) { await bulkSaveCommunityMembers(members); alert("Bulk Import Successful!"); fetchData(); } } } catch (err) { alert("Failed to parse CSV"); } }; reader.readAsText(file); };

    const handleSaveJob = async (e: React.FormEvent) => { e.preventDefault(); if(editingJobId) { await handleGenericSave(updateJob(editingJobId, newJob), "Job Updated!"); setEditingJobId(null); } else { await handleGenericSave(saveJob({...newJob, postedDate: new Date()}), "Job Posted!"); } setNewJob({ title: '', company: '', location: '', salary: '', employmentStatus: 'Full-time' }); };
    const handleEditJob = (job: Job) => { setNewJob(job); setEditingJobId(job.id || null); setModalType('create_job'); setIsModalOpen(true); };
    const handleAIJobParse = async () => { if (!rawJobText) return; setFormLoading(true); try { const ai = new GoogleGenAI({ apiKey: process.env.API_KEY }); const response = await ai.models.generateContent({ model: 'gemini-2.5-flash', contents: `Extract the following fields from this job post text into JSON: title, company, vacancy, deadline, jobContext, responsibilities, employmentStatus, workplace, educationalRequirements, experienceRequirements, additionalRequirements, location, salary, compensationAndBenefits, applyLink. Ensure keys match exactly. Text: ${rawJobText}`, config: { responseMimeType: "application/json", } }); const parsedData = JSON.parse(response.text || '{}'); setNewJob(prev => ({ ...prev, ...parsedData })); alert("Auto-filled with AI!"); } catch (e) { console.error("AI Parse Error:", e); alert("Failed to parse job details. Please fill manually."); } setFormLoading(false); };
    const handleSaveBlog = async (e: React.FormEvent) => { e.preventDefault(); if(editingBlogId) { await handleGenericSave(updateBlogPost(editingBlogId, newBlog), "Blog Updated!"); setEditingBlogId(null); } else { await handleGenericSave(saveBlogPost({...newBlog, date: new Date()}), "Blog Published!"); } setNewBlog({ title: '', excerpt: '', author: 'Admin', imageUrl: '', content: '' }); };
    const handleEditBlog = (blog: BlogPost) => { setNewBlog(blog); setEditingBlogId(blog.id || null); setModalType('create_blog'); setIsModalOpen(true); };

    // ... Filter Helpers ...
    const getFilteredEcosystemList = () => { let list = ecosystemApps; if (filterBatch !== 'All') { if (filterBatch === 'Unassigned') list = list.filter(app => !app.batch); else list = list.filter(app => app.batch === filterBatch); } if (filterStatus !== 'All') { list = list.filter(app => app.status.toLowerCase() === filterStatus.toLowerCase()); } if (filterDate) { list = list.filter(app => { const d = app.createdAt ? new Date(app.createdAt.seconds * 1000).toISOString().split('T')[0] : ''; return d === filterDate; }); } return filterData(list, ['name', 'phone', 'email', 'studentId', 'batch']); };
    const approvedStudents = getFilteredEcosystemList().filter(s => s.status === 'approved');
    const pendingStudents = getFilteredEcosystemList().filter(s => s.status !== 'approved');
    const getCommunityList = (type: string) => { const targetType = type === 'affiliate' ? 'Affiliate' : 'Campus Ambassador'; let list = affiliates.filter(a => a.type === targetType); if (comListFilter === 'pending') return list.filter(a => a.status === 'pending'); if (comListFilter === 'active') return list.filter(a => a.status === 'approved' || a.status === 'alumni'); return filterData(list, ['name', 'phone', 'institution']); };
    const getDatabaseCommunityList = () => { let list: any[] = []; const ambassadors = affiliates.filter(a => a.type === 'Campus Ambassador' && (a.status === 'approved' || a.status === 'alumni')).map(a => ({ ...a, role: 'Campus Ambassador', category: 'Campus Ambassador' })); const others = communityMembers.map(m => ({ ...m, role: m.role || 'Member', status: 'active' })); list = [...ambassadors, ...others]; if (communityDbFilter !== 'All') { list = list.filter(m => { const category = (m.category || '').toLowerCase(); const filter = communityDbFilter.toLowerCase(); return category.includes(filter); }); } return filterData(list, ['name', 'phone', 'email', 'role']); };

    const navItems = [{ id: 'overview', icon: LayoutDashboard, label: 'Overview' }, { id: 'ecosystem', icon: Layers, label: 'Ecosystem' }, { id: 'community', icon: Users, label: 'Community' }, { id: 'jobs', icon: Briefcase, label: 'Jobs' }, { id: 'blogs', icon: BookOpen, label: 'Blogs' }, { id: 'database', icon: Database, label: 'Database' }, { id: 'instructors', icon: UserCog, label: 'Instructors' }, { id: 'users', icon: UserPlus, label: 'Users' }];
    
    // Updated Access Check
    if (!user || (!ADMIN_EMAILS.includes(user.email || '') && user.role !== 'admin' && user.role !== 'moderator' && user.role !== 'super_admin')) {
        return <div className="p-10 text-center text-slate-500 font-bold">Access Denied. You do not have permission to view this page.</div>;
    }

    return (
        <div className="bg-[#2B2B52] min-h-screen flex font-['Hind_Siliguri'] overflow-hidden">
            <div className="w-64 bg-[#2B2B52] text-white flex flex-col h-screen fixed overflow-y-auto border-r border-white/10"><div className="p-6"><img src="https://iili.io/f3k62rG.md.png" className="h-10 brightness-0 invert object-contain" /></div><nav className="flex-1 px-4 space-y-2">{navItems.map(item => (<button key={item.id} onClick={() => {setActiveTab(item.id as any); setGlobalSearch(''); setSearchResults([]);}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === item.id ? 'bg-white/10 font-bold' : 'hover:bg-white/5 text-slate-400'}`}><item.icon size={18}/> {item.label}</button>))}</nav><div className="p-4"><button onClick={() => navigate('/')} className="w-full flex items-center gap-2 text-slate-400 hover:text-white p-2"><Home size={18}/> Home</button></div></div>
            <div className="flex-1 ml-64 bg-[#F4F7FE] h-screen overflow-y-auto p-8 rounded-l-[30px]">
                <div className="flex justify-between items-center mb-8 relative"><h2 className="text-2xl font-bold text-[#2B3674] capitalize">{activeTab.replace('_', ' ')}</h2><div className="relative w-96"><div className="bg-white p-2 rounded-full flex items-center shadow-sm border border-slate-200"><Search className="text-slate-400 mx-2" size={20}/><input className="bg-white outline-none flex-1 text-sm text-slate-800" placeholder="Global Search..." value={globalSearch} onChange={e => setGlobalSearch(e.target.value)}/></div>{searchResults.length > 0 && (<div className="absolute top-12 left-0 w-full bg-white rounded-xl shadow-xl z-50 p-2 max-h-64 overflow-y-auto">{searchResults.map((res, i) => (<div key={i} className="p-2 hover:bg-slate-50 rounded cursor-pointer border-b text-sm"><p className="font-bold text-[#2B3674]">{res.name} <span className="text-xs text-slate-400">({res.type})</span></p><p className="text-xs text-slate-500">{res.phone || res.email}</p></div>))}</div>)}</div></div>
                {loading ? <div className="text-center py-20">Loading...</div> : (
                    <>
                        {activeTab === 'overview' && (<div className="space-y-8 animate-fade-in"><div className="grid grid-cols-1 md:grid-cols-5 gap-6">{getStats().map((stat, i) => (<div key={i} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center text-center group hover:-translate-y-1 transition-transform"><div className={`w-12 h-12 rounded-full ${stat.bg} ${stat.color} flex items-center justify-center mb-3 group-hover:scale-110 transition-transform`}><stat.icon size={24} /></div><h3 className="text-3xl font-bold text-slate-800 mb-1">{stat.count}</h3><p className="text-slate-500 text-xs font-bold uppercase tracking-wider">{stat.label}</p></div>))}</div><div className="grid grid-cols-1 lg:grid-cols-3 gap-8 h-full"><div className="lg:col-span-1 space-y-6"><div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 h-full flex flex-col items-center"><h3 className="font-bold text-[#2B3674] mb-6 flex items-center gap-2 w-full"><Calendar size={20}/> Daily View</h3><input type="date" className="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-100 text-lg mb-6" value={overviewDate} onChange={e => setOverviewDate(e.target.value)}/><div className="w-full space-y-4"><div className="flex justify-between items-center p-3 bg-blue-50 rounded-xl"><span className="text-blue-700 font-bold text-sm">Joined Students</span><span className="bg-white px-3 py-1 rounded-lg text-blue-700 font-bold">{overviewData.students.length}</span></div><div className="flex justify-between items-center p-3 bg-purple-50 rounded-xl"><span className="text-purple-700 font-bold text-sm">Jobs Posted</span><span className="bg-white px-3 py-1 rounded-lg text-purple-700 font-bold">{overviewData.jobs.length}</span></div><div className="flex justify-between items-center p-3 bg-green-50 rounded-xl"><span className="text-green-700 font-bold text-sm">Payments Verified</span><span className="bg-white px-3 py-1 rounded-lg text-green-700 font-bold">{overviewData.payments.length}</span></div></div></div></div><div className="lg:col-span-2 bg-white p-6 rounded-3xl shadow-sm border border-slate-100"><h3 className="font-bold text-[#2B3674] mb-6 flex items-center gap-2"><Activity size={20}/> Recent System Activity</h3><div className="space-y-4 max-h-[500px] overflow-y-auto custom-scrollbar pr-2">{recentActivities.map((act, i) => (<div key={i} className="flex gap-4 p-3 hover:bg-slate-50 rounded-xl transition-colors border-b border-slate-50 last:border-0"><div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 font-bold text-white bg-${act.color}-500`}>{act.type.charAt(0)}</div><div className="flex-1"><div className="flex justify-between"><h4 className="font-bold text-slate-800 text-sm">{act.title}</h4><span className="text-[10px] text-slate-400 font-mono">{act.date.toLocaleDateString()}</span></div><p className="text-xs text-slate-500 mt-1">New {act.type} Entry{act.type === 'Ecosystem' && ' - Application Submitted'}{act.type === 'Job' && ' - Vacancy Posted'}</p></div></div>))}{recentActivities.length === 0 && <p className="text-center text-slate-400 py-10">No recent activity found.</p>}</div></div></div></div>)}
                        {activeTab === 'instructors' && (<div className="space-y-6 animate-fade-in"><div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100"><h3 className="font-bold text-slate-800 flex items-center gap-2"><UserCog size={20} className="text-blue-600"/> Instructor Management</h3><button onClick={() => { setModalType('add_instructor'); setIsModalOpen(true); }} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-blue-700"><Plus size={16}/> Add Instructor</button></div><div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><input className="w-full bg-white border border-slate-200 p-2 rounded-lg outline-none" placeholder="Search Instructors..." value={localSearch} onChange={e=>setLocalSearch(e.target.value)}/></div><div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-slate-50 border-b border-slate-100 text-slate-500"><tr><th className="p-4 w-12">#</th><th className="p-4">Name</th><th className="p-4">Email</th><th className="p-4">Role</th><th className="p-4 text-right">Action</th></tr></thead><tbody>{filterData(usersList.filter(u => u.role === 'instructor'), ['displayName', 'email']).map((inst, idx) => (<tr key={inst.uid} className="border-b border-slate-50 hover:bg-slate-50"><td className="p-4 font-mono text-slate-400">{idx + 1}</td><td className="p-4 font-bold text-slate-700">{inst.displayName}</td><td className="p-4 text-slate-500">{inst.email}</td><td className="p-4"><span className="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-bold">Instructor</span></td><td className="p-4 text-right"><button onClick={() => handleDemoteInstructor(inst.uid)} className="text-red-500 hover:bg-red-50 p-2 rounded font-bold text-xs">Remove Role</button></td></tr>))}{usersList.filter(u => u.role === 'instructor').length === 0 && <tr><td colSpan={5} className="p-8 text-center text-slate-400">No instructors found.</td></tr>}</tbody></table></div></div>)}
                        {/* ... (Community, Ecosystem, Jobs, Blogs, Users - Kept Same) ... */}
                        {activeTab === 'community' && (<div className="space-y-6 animate-fade-in"><div className="bg-white p-2 rounded-2xl shadow-sm border border-slate-100 mb-8 flex flex-wrap gap-2"><button onClick={()=>setCommunitySubTab('affiliate')} className={`flex items-center gap-2 px-6 py-3 rounded-xl text-sm font-bold transition-all ${communitySubTab === 'affiliate' ? 'bg-[#2B3674] text-white shadow-lg' : 'bg-white text-slate-500 hover:bg-slate-50'}`}><Share2 size={18}/> Affiliates</button><button onClick={()=>setCommunitySubTab('ambassador')} className={`flex items-center gap-2 px-6 py-3 rounded-xl text-sm font-bold transition-all ${communitySubTab === 'ambassador' ? 'bg-[#2B3674] text-white shadow-lg' : 'bg-white text-slate-500 hover:bg-slate-50'}`}><Award size={18}/> Ambassadors</button><button onClick={()=>setCommunitySubTab('task')} className={`flex items-center gap-2 px-6 py-3 rounded-xl text-sm font-bold transition-all ${communitySubTab === 'task' ? 'bg-[#2B3674] text-white shadow-lg' : 'bg-white text-slate-500 hover:bg-slate-50'}`}><CheckSquare size={18}/> Tasks</button><button onClick={()=>setCommunitySubTab('meeting')} className={`flex items-center gap-2 px-6 py-3 rounded-xl text-sm font-bold transition-all ${communitySubTab === 'meeting' ? 'bg-[#2B3674] text-white shadow-lg' : 'bg-white text-slate-500 hover:bg-slate-50'}`}><Video size={18}/> Meetings</button></div><div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-4"><input className="w-full bg-white border border-slate-200 p-2 rounded-lg outline-none" placeholder="Search in Community..." value={localSearch} onChange={e=>setLocalSearch(e.target.value)}/></div>{(communitySubTab === 'affiliate' || communitySubTab === 'ambassador') && (<div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100"><div className="flex gap-2"><button onClick={()=>setComListFilter('active')} className={`px-4 py-2 rounded-lg text-xs font-bold border transition-colors ${comListFilter==='active'?'bg-green-50 text-green-600 border-green-200':'text-slate-500 border-slate-200 hover:bg-slate-50'}`}>Active List</button><button onClick={()=>setComListFilter('pending')} className={`px-4 py-2 rounded-lg text-xs font-bold border transition-colors ${comListFilter==='pending'?'bg-orange-50 text-orange-600 border-orange-200':'text-slate-500 border-slate-200 hover:bg-slate-50'}`}>Pending Requests</button></div><div className="flex gap-2">{selectedIds.length > 0 && (<><button onClick={()=>handleBulkAction('approve')} className="bg-green-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-green-700 transition">Approve ({selectedIds.length})</button><button onClick={()=>handleBulkAction('ban')} className="bg-red-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-700 transition">Ban ({selectedIds.length})</button></>)}<button onClick={() => exportToCSV(getCommunityList(communitySubTab === 'affiliate' ? 'Affiliate' : 'Campus Ambassador'), `${communitySubTab}_list`)} className="flex items-center gap-2 text-slate-600 hover:text-[#2B3674] font-bold text-xs"><FileSpreadsheet size={16}/> Export CSV</button></div></div>)}<div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">{/* TASKS */}{communitySubTab === 'task' && (<div className="p-6"><div className="bg-slate-50 p-6 rounded-2xl mb-8 border border-slate-200"><h4 className="font-bold text-[#2B3674] mb-6 flex items-center gap-2"><CheckSquare size={20}/> Create New Task</h4><form onSubmit={handleSaveTask} className="grid md:grid-cols-2 gap-6"><div className="space-y-4"><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Title</label><input className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={newTaskForm.title || ''} onChange={e=>setNewTaskForm({...newTaskForm, title: e.target.value})} required/></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Description</label><textarea className="w-full p-3 border border-slate-200 rounded-xl h-24 bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={newTaskForm.description || ''} onChange={e=>setNewTaskForm({...newTaskForm, description: e.target.value})} required/></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Type</label><select className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={newTaskForm.type} onChange={e=>setNewTaskForm({...newTaskForm, type: e.target.value as any})}><option>Social Share</option><option>Event</option><option>Content</option><option>Other</option></select></div></div><div className="space-y-4"><div className="flex gap-4"><div className="flex-1"><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Points</label><input type="number" className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={newTaskForm.points || ''} onChange={e=>setNewTaskForm({...newTaskForm, points: Number(e.target.value)})}/></div><div className="flex-1"><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Deadline</label><input type="date" className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={newTaskForm.deadline || ''} onChange={e=>setNewTaskForm({...newTaskForm, deadline: e.target.value})} required/></div></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Link (Meeting/Resource)</label><input className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={newTaskForm.link || ''} onChange={e=>setNewTaskForm({...newTaskForm, link: e.target.value})}/></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Assign To</label><select className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={newTaskForm.assignedTo} onChange={e=>setNewTaskForm({...newTaskForm, assignedTo: e.target.value})}><option value="All">All Members</option><option value="Affiliates">All Affiliates</option><option value="Ambassadors">All Ambassadors</option></select></div><button className="w-full bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition mt-auto">Create Task</button></div></form></div><h4 className="font-bold text-slate-700 mb-4">Active Tasks List</h4><div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">{filterData(ambassadorTasks, ['title', 'description']).map(task => (<div key={task.id} className="p-5 border border-slate-100 rounded-2xl hover:shadow-md transition bg-white relative group"><div className="flex justify-between mb-2"><h5 className="font-bold text-slate-800 line-clamp-1">{task.title}</h5><span className="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-xs font-bold">{task.points} Pts</span></div><p className="text-sm text-slate-500 line-clamp-2 mb-4">{task.description}</p><div className="flex justify-between items-center pt-3 border-t border-slate-50"><span className="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded">Due: {task.deadline}</span><button onClick={()=>deleteAmbassadorTask(task.id!)} className="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50 transition"><Trash2 size={16}/></button></div></div>))}{ambassadorTasks.length === 0 && <p className="text-slate-400 col-span-3 text-center py-10">No tasks assigned yet.</p>}</div></div>)}{/* MEETINGS */}{communitySubTab === 'meeting' && (<div className="p-6"><div className="bg-slate-50 p-6 rounded-2xl mb-8 border border-slate-200"><h4 className="font-bold text-[#2B3674] mb-6 flex items-center gap-2"><Video size={20}/> Schedule Meeting</h4><form onSubmit={handleSaveMeeting} className="grid md:grid-cols-2 gap-6"><div className="space-y-4"><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Title</label><input className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={newMeetingForm.title || ''} onChange={e=>setNewMeetingForm({...newMeetingForm, title: e.target.value})} required placeholder="Weekly Sync..."/></div><div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Date</label><input type="date" className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={newMeetingForm.date || ''} onChange={e=>setNewMeetingForm({...newMeetingForm, date: e.target.value})} required/></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Time</label><input type="time" className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={newMeetingForm.time || ''} onChange={e=>setNewMeetingForm({...newMeetingForm, time: e.target.value})} required/></div></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Platform</label><select className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={newMeetingForm.platform} onChange={e=>setNewMeetingForm({...newMeetingForm, platform: e.target.value as any})}><option>Google Meet</option><option>Zoom</option><option>Offline</option></select></div></div><div className="space-y-4"><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Meeting Link / Location</label><input className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={newMeetingForm.link || ''} onChange={e=>setNewMeetingForm({...newMeetingForm, link: e.target.value})} required/></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Invitees</label><select className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={newMeetingForm.assignedTo} onChange={e=>setNewMeetingForm({...newMeetingForm, assignedTo: e.target.value})}><option value="All">All Members</option><option value="Affiliates">Affiliates Only</option><option value="Ambassadors">Ambassadors Only</option></select></div><button className="w-full bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition mt-auto">Schedule Meeting</button></div></form></div><h4 className="font-bold text-slate-700 mb-4">Upcoming Meetings</h4><div className="space-y-3">{filterData(communityMeetings, ['title', 'platform']).map(meeting => (<div key={meeting.id} className="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-xl hover:shadow-sm transition"><div className="flex items-center gap-4"><div className="bg-blue-50 text-blue-600 p-3 rounded-lg"><Video size={20}/></div><div><h5 className="font-bold text-slate-800">{meeting.title}</h5><p className="text-xs text-slate-500 flex items-center gap-2 mt-1"><Calendar size={12}/> {meeting.date} at {meeting.time} • <span className="bg-slate-100 px-1.5 rounded">{meeting.platform}</span></p></div></div><div className="flex items-center gap-3"><a href={meeting.link} target="_blank" className="text-xs font-bold text-blue-600 hover:underline">Join Link</a><button onClick={()=>deleteCommunityMeeting(meeting.id!)} className="text-slate-400 hover:text-red-500 transition"><Trash2 size={16}/></button></div></div>))}{communityMeetings.length === 0 && <p className="text-slate-400 text-center py-10">No meetings scheduled.</p>}</div></div>)}{/* LIST VIEW */}{(communitySubTab === 'affiliate' || communitySubTab === 'ambassador') && (<div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-slate-50 text-slate-500 font-bold border-b border-slate-100"><tr><th className="p-4 w-12">#</th><th className="p-4 w-10"><input type="checkbox" onChange={(e) => handleSelectAll(e.target.checked ? getCommunityList(communitySubTab).map(a=>a.id!) : [])}/></th><th className="p-4">Name & Contact</th>{communitySubTab === 'affiliate' ? (<><th className="p-4">Referral Info</th><th className="p-4">Earnings</th></>) : (<><th className="p-4">Institution</th><th className="p-4">Joining Date</th></>)}<th className="p-4">Status</th><th className="p-4 text-right">Actions</th></tr></thead><tbody>{getCommunityList(communitySubTab).map((member, idx) => (<tr key={member.id} className="border-b border-slate-50 hover:bg-slate-50 transition-colors"><td className="p-4 font-mono text-slate-400">{idx + 1}</td><td className="p-4"><input type="checkbox" checked={selectedIds.includes(member.id!)} onChange={() => handleSelect(member.id!)}/></td><td className="p-4"><div className="font-bold text-slate-800">{member.name}</div><div className="text-xs text-slate-500">{member.phone}</div></td>{communitySubTab === 'affiliate' ? (<><td className="p-4"><div className="flex flex-col gap-1"><span className="text-xs text-slate-500">Code: <span className="font-mono font-bold text-blue-600">{member.referralCode || 'N/A'}</span></span><span className="text-xs text-slate-500">Refs: <span className="font-bold text-slate-700">{member.referralCount || 0}</span></span></div></td><td className="p-4 font-mono font-bold text-green-600">৳{member.totalEarnings || 0}</td></>) : (<><td className="p-4 text-slate-600 font-medium">{member.institution}</td><td className="p-4 text-xs text-slate-500">{member.startDate ? new Date(member.startDate.seconds * 1000).toLocaleDateString() : 'Pending'}</td></>)}<td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold uppercase ${member.status==='approved'?'bg-green-100 text-green-600':member.status==='alumni'?'bg-blue-100 text-blue-600':member.status==='pending'?'bg-orange-100 text-orange-600':'bg-red-100 text-red-600'}`}>{member.status}</span></td><td className="p-4 text-right flex justify-end gap-2">{member.status === 'pending' ? (<button onClick={()=>handleApproveAffiliate(member.id!, member.name)} className="text-green-600 hover:bg-green-50 p-2 rounded flex items-center gap-1 font-bold text-xs border border-green-200"><CheckCircle size={14}/> Approve</button>) : (<><button onClick={()=>openMemberModal(member)} className="text-blue-600 hover:bg-blue-50 p-2 rounded flex items-center gap-1 font-bold text-xs border border-blue-100">Manage</button>{communitySubTab === 'ambassador' && member.status !== 'alumni' && (<button onClick={()=>handleCompleteTenure(member.id!)} className="text-purple-600 hover:bg-purple-50 p-2 rounded flex items-center gap-1 font-bold text-xs border border-purple-100" title="Mark as Alumni & Enable Certificate"><Award size={14}/> Complete</button>)}</>)}</td></tr>))}{getCommunityList(communitySubTab).length === 0 && <tr><td colSpan={7} className="p-8 text-center text-slate-400">No members found.</td></tr>}</tbody></table></div>)}</div></div>)}
                        {/* ... (Ecosystem Tab - Kept Same) ... */}
                        {activeTab === 'ecosystem' && (<div className="animate-fade-in"><div className="bg-white p-2 rounded-2xl shadow-sm border border-slate-100 mb-8 flex flex-wrap gap-2">{[{ id: 'list', label: 'Student List', icon: Users }, { id: 'batch', label: 'Batch Control', icon: BookOpenCheck }, { id: 'routine', label: 'Class Routine', icon: Calendar }, { id: 'attendance', label: 'Attendance', icon: CheckSquare }, { id: 'notice', label: 'Notice Board', icon: Megaphone }, { id: 'cv_resource', label: 'CV & Resources', icon: FileText }].map(t => (<button key={t.id} onClick={() => setEcoSubTab(t.id as any)} className={`flex items-center gap-2 px-6 py-3 rounded-xl text-sm font-bold transition-all duration-300 ${ecoSubTab === t.id ? 'bg-[#2B3674] text-white shadow-lg scale-105' : 'bg-white text-slate-500 hover:bg-slate-50 hover:text-slate-700'}`}><t.icon size={18} className={ecoSubTab === t.id ? 'text-white' : 'text-slate-400'}/> {t.label}</button>))}</div><div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-4"><input className="w-full bg-white border border-slate-200 p-2 rounded-lg outline-none" placeholder="Search in Ecosystem..." value={localSearch} onChange={e=>setLocalSearch(e.target.value)}/></div>{ecoSubTab === 'list' && (<div className="space-y-10"><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><h3 className="font-bold text-[#2B3674] text-lg mb-6 flex items-center gap-2"><div className="bg-green-100 p-2 rounded-lg text-green-600"><CheckCircle size={20}/></div>Active Students (Approved)</h3><div className="flex gap-4 mb-6"><select className="border border-slate-200 p-2.5 rounded-xl bg-white text-slate-800 text-sm outline-none font-bold" value={filterBatch} onChange={e=>setFilterBatch(e.target.value)}><option value="All">All Batches</option>{uniqueBatches.map(b=><option key={b}>{b}</option>)}</select><button onClick={() => setFilterBatch('All')} className="text-red-500 text-sm font-bold hover:underline">Reset Filter</button></div><div className="overflow-x-auto"><table className="w-full text-left text-sm border-separate border-spacing-y-2"><thead className="bg-slate-50 text-slate-500 uppercase text-xs font-bold tracking-wider"><tr><th className="p-4 rounded-l-xl w-12">#</th><th className="p-4">Student</th><th className="p-4">Batch Info</th><th className="p-4">Progress</th><th className="p-4 rounded-r-xl">Action</th></tr></thead><tbody>{approvedStudents.filter(s => filterBatch === 'All' || s.batch === filterBatch).map((app, idx) => (<tr key={app.id} className="bg-white hover:shadow-md transition-all duration-200 group"><td className="p-4 border-y border-l border-slate-100 rounded-l-xl font-mono text-slate-400">{idx + 1}</td><td className="p-4 border-y border-slate-100"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold overflow-hidden">{app.photoURL ? <img src={app.photoURL} alt="" className="w-full h-full object-cover"/> : app.name.charAt(0)}</div><div><p className="font-bold text-[#2B3674]">{app.name}</p><p className="text-xs text-slate-500 font-mono">{app.studentId || 'No ID'}</p></div></div></td><td className="p-4 border-y border-slate-100">{app.batch ? (<div><span className="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-100">{app.batch}</span><p className="text-[10px] text-slate-500 mt-1">Mod: {app.currentModule || 1}</p></div>) : <span className="text-red-400 text-xs italic">Unassigned</span>}</td><td className="p-4 border-y border-slate-100 text-xs text-slate-600">Att: <span className="font-bold">{app.scores?.attendance || 0}%</span> | Phase: <span className="font-bold">{app.currentPhase || 'N/A'}</span></td><td className="p-4 border-y border-r border-slate-100 rounded-r-xl flex gap-2"><button onClick={() => {setManageStudent(app); setStudentEditForm(app); setModalType('manage_student_full'); setIsModalOpen(true);}} className="text-blue-600 hover:bg-blue-50 px-3 py-2 rounded-lg border border-blue-200 text-xs font-bold transition-all flex items-center gap-2"><Edit size={14}/> Manage & Edit</button></td></tr>))}{approvedStudents.length === 0 && <tr><td colSpan={5} className="p-6 text-center text-slate-400">No active students found.</td></tr>}</tbody></table></div></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><h3 className="font-bold text-[#2B3674] text-lg mb-6 flex items-center gap-2"><div className="bg-orange-100 p-2 rounded-lg text-orange-600"><AlertCircle size={20}/></div>New Applications (Pending/Rejected)</h3><div className="overflow-x-auto"><table className="w-full text-left text-sm border-separate border-spacing-y-2"><thead className="bg-slate-50 text-slate-500 uppercase text-xs font-bold tracking-wider"><tr><th className="p-4 rounded-l-xl w-12">#</th><th className="p-4">Applicant Info</th><th className="p-4">Payment Details</th><th className="p-4">Status</th><th className="p-4 rounded-r-xl">Action</th></tr></thead><tbody>{pendingStudents.map((app, idx) => (<tr key={app.id} className="bg-slate-50/50 hover:bg-white hover:shadow-md transition-all duration-200"><td className="p-4 border-y border-l border-slate-100 rounded-l-xl font-mono text-slate-400">{idx + 1}</td><td className="p-4 border-y border-slate-100"><p className="font-bold text-slate-800">{app.name}</p><p className="text-xs text-slate-500">{app.phone}</p><p className="text-xs text-slate-400">{app.email}</p></td><td className="p-4 border-y border-slate-100"><div className="space-y-1"><div className="flex items-center gap-2"><span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${app.paymentMethod === 'Bkash' ? 'bg-pink-100 text-pink-600' : 'bg-orange-100 text-orange-600'}`}>{app.paymentMethod}</span><span className="font-mono font-bold text-slate-700">{app.transactionId}</span></div><p className="text-xs text-slate-500">Details: {app.paymentDetails || 'N/A'}</p></div></td><td className="p-4 border-y border-slate-100"><span className={`px-3 py-1 rounded-full text-xs font-bold uppercase border ${app.status==='rejected'?'bg-red-50 text-red-600 border-red-100':'bg-yellow-50 text-yellow-600 border-yellow-100'}`}>{app.status}</span></td><td className="p-4 border-y border-r border-slate-100 rounded-r-xl"><button onClick={() => {setManageStudent(app); setStudentEditForm(app); setModalType('manage_student_full'); setIsModalOpen(true);}} className="bg-white border border-slate-200 text-slate-600 hover:text-blue-600 hover:border-blue-200 px-3 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm">Review & Approve</button></td></tr>))}{pendingStudents.length === 0 && <tr><td colSpan={5} className="p-6 text-center text-slate-400">No pending applications.</td></tr>}</tbody></table></div></div></div>)}{/* ... (Other Eco subtabs) ... */}{ecoSubTab === 'batch' && <div className="grid md:grid-cols-3 gap-8 animate-fade-in"><div className="md:col-span-1"><div className="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm sticky top-6"><h3 className="font-bold text-[#2B3674] mb-6 flex items-center gap-3 text-xl border-b border-slate-100 pb-4"><div className="bg-indigo-100 p-2.5 rounded-xl text-indigo-600"><BookOpenCheck size={24}/></div>Update Batch Module</h3><form onSubmit={handleUpdateBatchModule} className="space-y-6"><div><label className="text-sm font-bold text-slate-500 mb-2 block uppercase tracking-wide">Target Batch</label><select required className="w-full p-4 border border-slate-200 rounded-2xl bg-white text-slate-800 font-bold focus:ring-4 focus:ring-indigo-100 outline-none transition-all" value={batchModuleForm.batch} onChange={e=>setBatchModuleForm({...batchModuleForm, batch: e.target.value})}><option value="">Select a Batch</option>{uniqueBatches.map(b=><option key={b} value={b}>{b}</option>)}</select></div><div><label className="text-sm font-bold text-slate-500 mb-2 block uppercase tracking-wide">Set Current Module</label><select required className="w-full p-4 border border-slate-200 rounded-2xl bg-white text-slate-800 font-bold focus:ring-4 focus:ring-indigo-100 outline-none transition-all" value={batchModuleForm.moduleId} onChange={e=>setBatchModuleForm({...batchModuleForm, moduleId: Number(e.target.value)})}>{MODULES.map(m => (<option key={m.id} value={m.id}>{m.title}</option>))}</select></div><div className="pt-4"><button className="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 flex items-center justify-center gap-2"><CheckCircle size={20}/> Update Module</button></div></form></div></div><div className="md:col-span-2"><div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm"><h3 className="font-bold text-[#2B3674] mb-6 text-lg border-b border-slate-100 pb-2">Active Batches Status</h3><div className="overflow-x-auto"><table className="w-full text-left text-sm border-separate border-spacing-y-2"><thead><tr className="text-slate-500 text-xs uppercase bg-slate-50 sticky top-0"><th className="px-4 py-3 rounded-l-lg w-12">#</th><th className="px-4 py-3">Batch Name</th><th className="px-4 py-3">Current Module</th><th className="px-4 py-3">Phase</th><th className="px-4 py-3 rounded-r-lg">Students</th></tr></thead><tbody>{batchStatusList.map((batch, idx) => (<tr key={idx} className="bg-slate-50 hover:bg-white hover:shadow-sm transition-all rounded-lg"><td className="px-4 py-4 font-mono text-slate-400">{idx + 1}</td><td className="px-4 py-4"><span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-bold">{batch.batchName}</span></td><td className="px-4 py-4 font-bold text-slate-700">Module {batch.currentModule}</td><td className="px-4 py-4 text-xs font-bold text-slate-500 uppercase">{batch.currentPhase}</td><td className="px-4 py-4 font-mono font-bold text-slate-800">{batch.studentCount}</td></tr>))}{batchStatusList.length === 0 && <tr><td colSpan={5} className="text-center py-8 text-slate-400">No active batches found.</td></tr>}</tbody></table></div></div></div></div>}{ecoSubTab === 'routine' && <div className="p-6"><div className="bg-slate-50 p-6 rounded-2xl mb-8 border border-slate-200"><h4 className="font-bold text-[#2B3674] mb-6 flex items-center gap-2"><Calendar size={20}/> Schedule New Class</h4><form onSubmit={handleAddClass} className="grid md:grid-cols-2 gap-6"><div className="space-y-4"><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Target Batch</label><select className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={classSessionForm.batch} onChange={e=>setClassSessionForm({...classSessionForm, batch: e.target.value})} required><option value="">Select Batch</option>{uniqueBatches.map(b=><option key={b} value={b}>{b}</option>)}</select></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Class Topic</label><input className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={classSessionForm.topic} onChange={e=>setClassSessionForm({...classSessionForm, topic: e.target.value})} required/></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Mentor Name</label><input className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={classSessionForm.mentorName} onChange={e=>setClassSessionForm({...classSessionForm, mentorName: e.target.value})} required/></div></div><div className="space-y-4"><div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Date</label><input type="date" className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={classSessionForm.date} onChange={e=>setClassSessionForm({...classSessionForm, date: e.target.value})} required/></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Time</label><input type="time" className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={classSessionForm.time} onChange={e=>setClassSessionForm({...classSessionForm, time: e.target.value})} required/></div></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Class Link (Google Meet/Zoom)</label><input className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" value={classSessionForm.link} onChange={e=>setClassSessionForm({...classSessionForm, link: e.target.value})} required/></div><div className="flex gap-2">{editingSessionId && <button type="button" onClick={cancelEditClass} className="px-4 py-3 bg-slate-200 rounded-xl font-bold">Cancel</button>}<button className="flex-1 bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition">{editingSessionId ? 'Update Schedule' : 'Schedule Class'}</button></div></div></form></div><div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden"><div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h4 className="font-bold text-slate-700">Upcoming Classes</h4><select className="p-2 text-sm border rounded-lg bg-white" value={routineFilterBatch} onChange={e=>setRoutineFilterBatch(e.target.value)}><option value="All">All Batches</option>{uniqueBatches.map(b=><option key={b} value={b}>{b}</option>)}</select></div><table className="w-full text-left text-sm"><thead className="bg-slate-50 text-slate-500"><tr><th className="p-4 w-12">#</th><th className="p-4">Date & Time</th><th className="p-4">Batch</th><th className="p-4">Topic & Mentor</th><th className="p-4">Link</th><th className="p-4 text-right">Actions</th></tr></thead><tbody>{filterData(classSessions.filter(s => routineFilterBatch === 'All' || s.batch === routineFilterBatch), ['topic', 'mentorName']).map((session, idx) => (<tr key={session.id} className="border-b border-slate-50 hover:bg-slate-50"><td className="p-4 font-mono text-slate-400">{idx + 1}</td><td className="p-4"><div className="font-bold text-slate-800">{session.date}</div><div className="text-xs text-slate-500">{session.time}</div></td><td className="p-4"><span className="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">{session.batch}</span></td><td className="p-4"><div className="font-bold text-slate-700">{session.topic}</div><div className="text-xs text-slate-500">by {session.mentorName}</div></td><td className="p-4"><a href={session.link} target="_blank" className="text-blue-600 underline text-xs font-bold">Join Class</a></td><td className="p-4 text-right flex justify-end gap-2"><button onClick={()=>handleEditClass(session)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Edit size={16}/></button><button onClick={()=>deleteClassSession(session.id!)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 size={16}/></button></td></tr>))}{classSessions.length === 0 && <tr><td colSpan={5} className="p-8 text-center text-slate-400">No classes scheduled.</td></tr>}</tbody></table></div></div>}{ecoSubTab === 'attendance' && <div className="p-6 space-y-6"><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-wrap gap-4 items-end"><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Select Batch</label><select className="p-3 border border-slate-200 rounded-xl bg-white w-48 font-bold" value={filterBatch} onChange={e=>setFilterBatch(e.target.value)}><option value="All">Select a Batch</option>{uniqueBatches.map(b=><option key={b} value={b}>{b}</option>)}</select></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Date</label><input type="date" className="p-3 border border-slate-200 rounded-xl bg-white font-bold" value={attendanceDate} onChange={e=>setAttendanceDate(e.target.value)}/></div><div className="pb-3 text-slate-500 text-sm italic ml-auto">*Select a batch to mark attendance</div></div>{filterBatch !== 'All' ? (<div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-slate-50 text-slate-500"><tr><th className="p-4 w-12">#</th><th className="p-4">Student ID</th><th className="p-4">Name</th><th className="p-4 text-center">Status</th><th className="p-4 text-right">Action</th></tr></thead><tbody>{ecosystemApps.filter(s => s.batch === filterBatch && s.status === 'approved').map((student, idx) => { const status = student.attendanceRecord?.[attendanceDate]; return (<tr key={student.id} className="border-b border-slate-50 hover:bg-slate-50"><td className="p-4 font-mono text-slate-400">{idx + 1}</td><td className="p-4 font-mono font-bold text-blue-600">{student.studentId}</td><td className="p-4"><div className="font-bold text-slate-800">{student.name}</div><div className="text-xs text-slate-500">{student.phone}</div></td><td className="p-4 text-center flex justify-center gap-2"><button onClick={() => handleAttendance(student.id!, 'Present')} className={`px-4 py-2 rounded-lg font-bold text-xs transition-all ${status === 'Present' ? 'bg-green-600 text-white shadow-lg' : 'bg-slate-100 text-slate-400 hover:bg-green-100 hover:text-green-600'}`}>Present</button><button onClick={() => handleAttendance(student.id!, 'Absent')} className={`px-4 py-2 rounded-lg font-bold text-xs transition-all ${status === 'Absent' ? 'bg-red-600 text-white shadow-lg' : 'bg-slate-100 text-slate-400 hover:bg-red-100 hover:text-red-600'}`}>Absent</button></td><td className="p-4 text-right"><button onClick={() => viewAttendanceHistory(student)} className="text-blue-600 hover:underline text-xs font-bold flex items-center justify-end gap-1"><Clock size={14}/> History</button></td></tr>); })}</tbody></table></div>) : (<div className="text-center py-20 bg-white rounded-2xl border border-dashed border-slate-300"><Users size={48} className="mx-auto text-slate-300 mb-4"/><p className="text-slate-500">Please select a batch above to view students list.</p></div>)}</div>}{ecoSubTab === 'notice' && <div className="p-6 grid md:grid-cols-3 gap-8"><div className="md:col-span-1"><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 sticky top-6"><h4 className="font-bold text-[#2B3674] mb-6 flex items-center gap-2"><Megaphone size={20}/> Send Notice</h4><form onSubmit={handleSendNotice} className="space-y-4"><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Target Audience</label><select className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-purple-100 outline-none" value={noticeForm.targetBatch} onChange={e=>setNoticeForm({...noticeForm, targetBatch: e.target.value})}><option value="All">All Active Students</option>{uniqueBatches.map(b=><option key={b} value={b}>{b}</option>)}</select></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Title</label><input className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-purple-100 outline-none" value={noticeForm.title} onChange={e=>setNoticeForm({...noticeForm, title: e.target.value})} required placeholder="Important Update..."/></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Message</label><textarea className="w-full p-3 border border-slate-200 rounded-xl h-32 bg-white focus:ring-2 focus:ring-purple-100 outline-none" value={noticeForm.message} onChange={e=>setNoticeForm({...noticeForm, message: e.target.value})} required/></div><div className="flex gap-2">{editingNoticeId && <button type="button" onClick={cancelEditNotice} className="px-4 py-3 bg-slate-200 rounded-xl font-bold">Cancel</button>}<button className="flex-1 bg-purple-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-purple-700 transition shadow-lg shadow-purple-200">{editingNoticeId ? 'Update Notice' : 'Send Notice'}</button></div></form></div></div><div className="md:col-span-2"><h4 className="font-bold text-slate-700 mb-4">Notice History</h4><div className="space-y-4">{filterData(noticesHistory, ['title', 'message']).map((notice, idx) => (<div key={idx} className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm relative group"><div className="flex justify-between items-start mb-2"><span className="bg-purple-50 text-purple-700 px-2 py-1 rounded text-xs font-bold">To: {notice.targetBatch}</span><div className="flex gap-2"><button onClick={()=>handleEditNotice(notice)} className="text-slate-400 hover:text-blue-500"><Edit size={14}/></button><span className="text-xs text-slate-400">{notice.createdAt ? new Date(notice.createdAt.seconds * 1000).toLocaleDateString() : 'Just now'}</span></div></div><h5 className="font-bold text-slate-800 text-lg">{notice.title}</h5><p className="text-slate-600 text-sm mt-2 whitespace-pre-wrap">{notice.message}</p></div>))}{noticesHistory.length === 0 && <p className="text-center text-slate-400 py-10 bg-white rounded-2xl border border-dashed border-slate-200">No notices sent yet.</p>}</div></div></div>}{ecoSubTab === 'cv_resource' && <div className="p-6 grid md:grid-cols-3 gap-8"><div className="md:col-span-1"><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 sticky top-6"><h4 className="font-bold text-[#2B3674] mb-6 flex items-center gap-2"><FileText size={20}/> Upload Resource</h4><form onSubmit={handleAddResource} className="space-y-4"><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Resource Title</label><input className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-green-100 outline-none" value={resourceForm.title} onChange={e=>setResourceForm({...resourceForm, title: e.target.value})} required/></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Type</label><select className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-green-100 outline-none" value={resourceForm.type} onChange={e=>setResourceForm({...resourceForm, type: e.target.value})}><option>PDF</option><option>Video</option><option>Link</option><option>CV Template</option></select></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Link / URL</label><input className="w-full p-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-green-100 outline-none" value={resourceForm.link} onChange={e=>setResourceForm({...resourceForm, link: e.target.value})} required placeholder="Drive/Youtube Link..."/></div><div className="flex gap-2">{editingResourceId && <button type="button" onClick={cancelEditResource} className="px-4 py-3 bg-slate-200 rounded-xl font-bold">Cancel</button>}<button className="flex-1 bg-green-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-700 transition shadow-lg shadow-green-200">{editingResourceId ? 'Update' : 'Upload'}</button></div></form></div></div><div className="md:col-span-2"><h4 className="font-bold text-slate-700 mb-4">Resource Library</h4><div className="grid sm:grid-cols-2 gap-4">{filterData(resourcesList, ['title']).map((res, idx) => (<div key={idx} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition flex items-start gap-3 relative group"><div className="bg-green-50 p-3 rounded-lg text-green-600 shrink-0">{res.type === 'Video' ? <Video size={20}/> : <LinkIcon size={20}/>}</div><div className="flex-1 min-w-0"><h5 className="font-bold text-slate-800 text-sm truncate">{res.title}</h5><p className="text-xs text-slate-500 mt-1">{res.type}</p><a href={res.link} target="_blank" className="text-xs text-blue-600 font-bold hover:underline mt-2 inline-block">Access Resource</a></div><div className="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={()=>handleEditResource(res)} className="text-slate-400 hover:text-blue-500 p-1"><Edit size={14}/></button><button onClick={()=>deleteResource(res.id)} className="text-slate-400 hover:text-red-500 p-1"><Trash2 size={14}/></button></div></div>))}{resourcesList.length === 0 && <p className="text-center text-slate-400 py-10 col-span-2 bg-white rounded-2xl border border-dashed border-slate-200">No resources uploaded.</p>}</div></div></div>}</div>)}
                        {activeTab === 'database' && (<div className="space-y-6 animate-fade-in"><div className="flex justify-between items-center border-b border-slate-200 pb-2"><div className="flex gap-4"><button onClick={() => setDatabaseTab('leads')} className={`pb-2 font-bold transition-colors ${databaseTab === 'leads' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500'}`}>Leads</button><button onClick={() => setDatabaseTab('interests')} className={`pb-2 font-bold transition-colors ${databaseTab === 'interests' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500'}`}>Job Interests</button><button onClick={() => setDatabaseTab('community_db')} className={`pb-2 font-bold transition-colors ${databaseTab === 'community_db' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500'}`}>Community DB</button></div><button onClick={() => exportToCSV(databaseTab === 'leads' ? leads : databaseTab === 'community_db' ? getDatabaseCommunityList() : jobInterests, `${databaseTab}_export`)} className="flex items-center gap-2 text-slate-600 hover:text-[#2B3674] font-bold text-xs"><FileSpreadsheet size={16}/> Export CSV</button></div><div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-4"><input className="w-full bg-white border border-slate-200 p-2 rounded-lg outline-none" placeholder="Search Database..." value={localSearch} onChange={e=>setLocalSearch(e.target.value)}/></div>{databaseTab === 'leads' ? (<div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-slate-50 border-b border-slate-100 text-slate-500"><tr><th className="p-4 w-12">#</th><th className="p-4">Name</th><th className="p-4">Phone</th><th className="p-4">Goal</th><th className="p-4 text-right">Action</th></tr></thead><tbody>{filterData(leads, ['name', 'phone']).map((lead, idx) => (<tr key={idx} className="border-b border-slate-50 hover:bg-slate-50"><td className="p-4 font-mono text-slate-400">{idx + 1}</td><td className="p-4 font-bold text-slate-700">{lead.name}</td><td className="p-4">{lead.phone}</td><td className="p-4 text-slate-500">{lead.goal}</td><td className="p-4 text-right flex justify-end gap-2"><button onClick={()=>handleEditLead(lead)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Edit size={16}/></button><button onClick={()=>deleteLead(lead.id!)} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button></td></tr>))}</tbody></table></div>) : databaseTab === 'community_db' ? (<div className="space-y-4"><div className="flex flex-wrap gap-2 items-center justify-between"><div className="flex flex-wrap gap-2">{['All', 'Central', 'Sub-Central', 'Division Team', 'District Team', 'Campus Ambassador', 'Volunteer'].map(cat => (<button key={cat} onClick={() => setCommunityDbFilter(cat)} className={`px-3 py-1.5 rounded-full text-xs font-bold border transition-all ${communityDbFilter === cat ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}>{cat}</button>))}</div><div className="flex gap-2"><button onClick={() => { setModalType('add_db_member'); setIsModalOpen(true); }} className="flex items-center gap-2 bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-green-700 transition"><AddUser size={14}/> Add Member</button><label className="flex items-center gap-2 bg-slate-800 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-slate-900 transition cursor-pointer"><Upload size={14}/> Bulk Import<input type="file" accept=".csv" onChange={handleBulkImport} className="hidden" /></label></div></div><div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-slate-50 border-b border-slate-100 text-slate-500"><tr><th className="p-4 w-12">#</th><th className="p-4">Name</th><th className="p-4">Role & Category</th><th className="p-4">Contact</th><th className="p-4 text-right">Action</th></tr></thead><tbody>{getDatabaseCommunityList().map((member: any, idx) => (<tr key={idx} className="border-b border-slate-50 hover:bg-slate-50"><td className="p-4 font-mono text-slate-400">{idx + 1}</td><td className="p-4 font-bold text-slate-700">{member.name}</td><td className="p-4"><span className="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold">{member.role}</span>{member.category && <p className="text-[10px] text-slate-400 mt-1 uppercase font-bold">{member.category}</p>}</td><td className="p-4 text-slate-600 text-xs">{member.phone}<br/>{member.email}</td><td className="p-4 text-right flex justify-end gap-2"><button onClick={()=>handleEditDbMember(member)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Edit size={16}/></button><button onClick={() => {if(window.confirm('Delete this member from database?')) {if(member.id && member.type === 'Campus Ambassador') updateAffiliateStatus(member.id, 'banned'); else if(member.id) deleteCommunityMember(member.id);}}} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button></td></tr>))}{getDatabaseCommunityList().length === 0 && <tr><td colSpan={5} className="p-8 text-center text-slate-400">No members found in this category.</td></tr>}</tbody></table></div></div>) : (<div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-slate-50 border-b border-slate-100 text-slate-500"><tr><th className="p-4 w-12">#</th><th className="p-4">User</th><th className="p-4">Job Title</th><th className="p-4">Time</th><th className="p-4 text-right">Action</th></tr></thead><tbody>{filterData(jobInterests, ['userName', 'jobTitle']).map((interest, idx) => (<tr key={idx} className="border-b border-slate-50 hover:bg-slate-50"><td className="p-4 font-mono text-slate-400">{idx + 1}</td><td className="p-4 font-bold text-slate-700">{interest.userName}<br/><span className="text-xs text-slate-400 font-normal">{interest.userEmail}</span></td><td className="p-4">{interest.jobTitle}</td><td className="p-4 text-slate-500 text-xs">{interest.clickedAt ? new Date(interest.clickedAt.seconds * 1000).toLocaleString() : 'N/A'}</td><td className="p-4 text-right"><button onClick={()=>deleteJobInterest(interest.id!)} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button></td></tr>))}</tbody></table></div>)}</div>)}
                        {/* ... (Users Tab - Kept Same) ... */}
                        {activeTab === 'jobs' && (<div className="space-y-6 animate-fade-in"><div className="flex justify-between items-center"><h3 className="text-xl font-bold text-slate-800">Job Management</h3><button onClick={() => { setNewJob({ title: '', company: '', location: '', salary: '', employmentStatus: 'Full-time' }); setEditingJobId(null); setRawJobText(''); setModalType('create_job'); setIsModalOpen(true); }} className="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2 hover:bg-blue-700 transition"><Plus size={18}/> Post New Job</button></div><div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-4"><input className="w-full bg-white border border-slate-200 p-2 rounded-lg outline-none" placeholder="Search Jobs..." value={localSearch} onChange={e=>setLocalSearch(e.target.value)}/></div><div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-slate-50 border-b border-slate-100 text-slate-500"><tr><th className="p-4 w-12">#</th><th className="p-4">Title</th><th className="p-4">Company</th><th className="p-4">Deadline</th><th className="p-4 text-right">Action</th></tr></thead><tbody>{filterData(jobs, ['title', 'company']).map((job, idx) => (<tr key={job.id} className="border-b border-slate-50 hover:bg-slate-50"><td className="p-4 font-mono text-slate-400">{idx + 1}</td><td className="p-4 font-bold text-slate-800">{job.title}</td><td className="p-4 text-slate-600">{job.company}</td><td className="p-4 text-slate-500">{job.deadline}</td><td className="p-4 flex justify-end gap-2"><button onClick={() => { setViewingJobInterests(job.id!); setIsModalOpen(true); setModalType('view_interests'); }} className="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-100 transition flex items-center gap-1"><Eye size={14}/> Viewers</button><button onClick={() => handleEditJob(job)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Edit size={16}/></button><button onClick={() => { if(window.confirm('Delete job?')) deleteJob(job.id!) }} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 size={16}/></button></td></tr>))}</tbody></table></div></div>)}
                        {activeTab === 'blogs' && (<div className="space-y-6 animate-fade-in"><div className="flex justify-between items-center"><h3 className="text-xl font-bold text-slate-800">Blog Management</h3><button onClick={() => { setNewBlog({ title: '', excerpt: '', author: 'Admin', imageUrl: '', content: '' }); setEditingBlogId(null); setModalType('create_blog'); setIsModalOpen(true); }} className="bg-purple-600 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2 hover:bg-purple-700 transition"><Plus size={18}/> Write New Blog</button></div><div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-4"><input className="w-full bg-white border border-slate-200 p-2 rounded-lg outline-none" placeholder="Search Blogs..." value={localSearch} onChange={e=>setLocalSearch(e.target.value)}/></div><div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">{filterData(blogs, ['title', 'author']).map(blog => (<div key={blog.id} className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm relative group"><h4 className="font-bold text-slate-800 line-clamp-1 mb-2">{blog.title}</h4><p className="text-xs text-slate-500 mb-4 line-clamp-2">{blog.excerpt}</p><div className="flex justify-between items-center text-xs text-slate-400"><span>{blog.author}</span><div className="flex gap-2"><button onClick={() => handleEditBlog(blog)} className="text-blue-500 hover:text-blue-700 font-bold">Edit</button><button onClick={() => { if(window.confirm('Delete blog?')) deleteBlogPost(blog.id!) }} className="text-red-500 hover:text-red-700 font-bold">Delete</button></div></div></div>))}</div></div>)}
                        {activeTab === 'users' && (<div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden animate-fade-in"><div className="p-4 border-b border-slate-100"><h3 className="font-bold text-slate-800">User List ({usersList.length})</h3></div><div className="p-4 border-b border-slate-100"><input className="w-full bg-white border border-slate-200 p-2 rounded-lg outline-none" placeholder="Search Users..." value={localSearch} onChange={e=>setLocalSearch(e.target.value)}/></div><table className="w-full text-left text-sm"><thead className="bg-slate-50 border-b border-slate-100 text-slate-500"><tr><th className="p-4 w-12">#</th><th className="p-4">Name</th><th className="p-4">Email</th><th className="p-4">Role</th><th className="p-4">Joined</th><th className="p-4">Action</th></tr></thead><tbody>{filterData(usersList, ['displayName', 'email']).map((u, idx) => (<tr key={u.uid} className="border-b border-slate-50 hover:bg-slate-50"><td className="p-4 font-mono text-slate-400">{idx + 1}</td><td className="p-4 font-bold text-slate-700">{u.displayName}</td><td className="p-4 text-slate-500">{u.email}</td><td className="p-4"><span className="bg-slate-100 px-2 py-1 rounded text-xs font-bold">{u.role}</span></td><td className="p-4 text-xs text-slate-400">{u.createdAt ? new Date(u.createdAt.seconds*1000).toLocaleDateString() : 'N/A'}</td><td className="p-4"><button onClick={()=> { if(window.confirm('Delete User?')) deleteUserDoc(u.uid) }} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 size={16}/></button></td></tr>))}</tbody></table></div>)}
                    </>
                )}
            </div>

            {/* --- MODALS --- */}
            {isModalOpen && (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm overflow-y-auto">
                    <div className={`bg-white rounded-3xl w-full shadow-2xl flex flex-col max-h-[95vh] animate-fade-in-up ${['manage_student_full', 'manage_member', 'create_job', 'add_instructor'].includes(modalType || '') ? 'max-w-5xl' : 'max-w-2xl'}`}>
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 className="font-bold text-xl text-slate-800 capitalize">{modalType?.replace(/_/g, ' ')}</h3>
                            <button onClick={()=>setIsModalOpen(false)} className="p-2 bg-slate-100 rounded-full hover:bg-red-50 hover:text-red-500 transition-colors"><X size={20}/></button>
                        </div>
                        <div className="p-8 overflow-y-auto custom-scrollbar">
                            
                            {modalType === 'add_instructor' && (<div><h4 className="font-bold text-slate-800 mb-4">Search and Promote User to Instructor</h4><div className="relative mb-6"><Search className="absolute left-3 top-3 text-slate-400" size={18}/><input className="w-full pl-10 p-3 border rounded-xl bg-white focus:ring-2 focus:ring-blue-100 outline-none" placeholder="Search by name or email..." value={instructorSearch} onChange={e => setInstructorSearch(e.target.value)}/></div><div className="max-h-60 overflow-y-auto border rounded-xl">{usersList.filter(u => u.role !== 'instructor' && (u.displayName?.toLowerCase().includes(instructorSearch.toLowerCase()) || u.email?.toLowerCase().includes(instructorSearch.toLowerCase()))).map(u => (<div key={u.uid} className="flex justify-between items-center p-3 border-b hover:bg-slate-50 last:border-b-0"><div><p className="font-bold text-slate-800">{u.displayName}</p><p className="text-xs text-slate-500">{u.email}</p></div><button onClick={() => handlePromoteInstructor(u.uid)} className="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-700">Promote</button></div>))}{instructorSearch && usersList.filter(u => u.displayName?.toLowerCase().includes(instructorSearch.toLowerCase())).length === 0 && (<p className="p-4 text-center text-slate-400">No users found.</p>)}</div></div>)}
                            {modalType === 'create_job' && (<div className="p-4"><div className="mb-8 bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-2xl border border-blue-100"><h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Sparkles size={18} className="text-blue-600"/> Auto-Fill from Text (AI)</h4><textarea placeholder="Paste raw job post text here..." className="w-full p-4 rounded-xl bg-white border border-blue-200 text-slate-600 text-sm h-32 mb-4 focus:ring-2 focus:ring-blue-400 outline-none" value={rawJobText} onChange={e => setRawJobText(e.target.value)}/><button type="button" onClick={handleAIJobParse} disabled={formLoading || !rawJobText} className="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition flex items-center gap-2 disabled:opacity-50">{formLoading ? 'Parsing...' : <><Sparkles size={16}/> Parse & Fill</>}</button></div><h4 className="font-bold text-slate-800 mb-6 flex items-center gap-2 text-lg"><Briefcase size={20}/> {editingJobId ? 'Edit Job' : 'Post New Job'}</h4><form onSubmit={handleSaveJob} className="space-y-4"><input required placeholder="Job Title" className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none" value={newJob.title} onChange={e=>setNewJob({...newJob, title: e.target.value})}/><input required placeholder="Company Name" className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none" value={newJob.company} onChange={e=>setNewJob({...newJob, company: e.target.value})}/><div className="grid grid-cols-2 gap-4"><input required placeholder="Location" className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none" value={newJob.location} onChange={e=>setNewJob({...newJob, location: e.target.value})}/><input required placeholder="Salary Range" className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none" value={newJob.salary} onChange={e=>setNewJob({...newJob, salary: e.target.value})}/></div><div className="grid grid-cols-2 gap-4"><select className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 outline-none" value={newJob.employmentStatus} onChange={e=>setNewJob({...newJob, employmentStatus: e.target.value as any})}><option>Full-time</option><option>Part-time</option><option>Internship</option><option>Contractual</option></select><input type="date" className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 outline-none" value={newJob.deadline || ''} onChange={e=>setNewJob({...newJob, deadline: e.target.value})}/></div><input required placeholder="Application Link / Email" className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none" value={newJob.applyLink || ''} onChange={e=>setNewJob({...newJob, applyLink: e.target.value})}/><div className="space-y-4 pt-4 border-t border-slate-100"><h5 className="font-bold text-slate-500 text-sm uppercase">Details</h5><textarea placeholder="Job Context..." className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none h-20" value={newJob.jobContext || ''} onChange={e=>setNewJob({...newJob, jobContext: e.target.value})}/><textarea placeholder="Responsibilities..." className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none h-32" value={newJob.responsibilities || ''} onChange={e=>setNewJob({...newJob, responsibilities: e.target.value})}/><textarea placeholder="Educational Requirements..." className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none h-20" value={newJob.educationalRequirements || ''} onChange={e=>setNewJob({...newJob, educationalRequirements: e.target.value})}/><textarea placeholder="Compensation & Benefits..." className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none h-20" value={newJob.compensationAndBenefits || ''} onChange={e=>setNewJob({...newJob, compensationAndBenefits: e.target.value})}/></div><button className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition mt-4">{editingJobId ? 'Update Job' : 'Post Job'}</button></form></div>)}
                            {modalType === 'add_db_member' && (<div className="space-y-6"><h4 className="font-bold text-slate-800 flex items-center gap-2"><Database size={20}/> Add Member to Database</h4><form onSubmit={handleAddMemberToDb} className="grid md:grid-cols-2 gap-4"><input required placeholder="Full Name" className="w-full p-3 bg-white border rounded-xl" value={newMemberForm.name || ''} onChange={e=>setNewMemberForm({...newMemberForm, name: e.target.value})}/><input required placeholder="Phone Number" className="w-full p-3 bg-white border rounded-xl" value={newMemberForm.phone || ''} onChange={e=>setNewMemberForm({...newMemberForm, phone: e.target.value})}/><input placeholder="Email (Optional)" className="w-full p-3 bg-white border rounded-xl" value={newMemberForm.email || ''} onChange={e=>setNewMemberForm({...newMemberForm, email: e.target.value})}/><input placeholder="Role / Position" className="w-full p-3 bg-white border rounded-xl" value={newMemberForm.role || ''} onChange={e=>setNewMemberForm({...newMemberForm, role: e.target.value})}/><div className="col-span-2"><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Category</label><select className="w-full p-3 border rounded-xl bg-white" value={newMemberForm.category} onChange={e=>setNewMemberForm({...newMemberForm, category: e.target.value})}><option>Central</option><option>Sub-Central</option><option>Division Team</option><option>District Team</option><option>Campus Ambassador</option><option>Volunteer</option></select></div><button className="col-span-2 bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 transition">Save Member</button></form></div>)}
                            {modalType === 'edit_lead' && selectedLead && (<div className="space-y-6"><h4 className="font-bold text-slate-800 flex items-center gap-2"><Edit size={20}/> Edit Lead</h4><form onSubmit={(e) => {e.preventDefault(); handleGenericSave(updateData('leads', selectedLead.id!, leadEditForm), "Lead Updated");}} className="grid md:grid-cols-2 gap-4"><input required placeholder="Name" className="w-full p-3 bg-white border rounded-xl" value={leadEditForm.name || selectedLead.name} onChange={e=>setLeadEditForm({...leadEditForm, name: e.target.value})}/><input required placeholder="Phone" className="w-full p-3 bg-white border rounded-xl" value={leadEditForm.phone || selectedLead.phone} onChange={e=>setLeadEditForm({...leadEditForm, phone: e.target.value})}/><input placeholder="Email" className="w-full p-3 bg-white border rounded-xl" value={leadEditForm.email || selectedLead.email} onChange={e=>setLeadEditForm({...leadEditForm, email: e.target.value})}/><input placeholder="Profession" className="w-full p-3 bg-white border rounded-xl" value={leadEditForm.profession || selectedLead.profession} onChange={e=>setLeadEditForm({...leadEditForm, profession: e.target.value})}/><div className="col-span-2"><input placeholder="Goal" className="w-full p-3 bg-white border rounded-xl" value={leadEditForm.goal || selectedLead.goal} onChange={e=>setLeadEditForm({...leadEditForm, goal: e.target.value})}/></div><button className="col-span-2 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">Update Lead</button></form></div>)}
                            {modalType === 'view_interests' && viewingJobInterests && (<div><h4 className="font-bold text-slate-700 mb-4">Users who viewed this job application details:</h4><div className="max-h-[400px] overflow-y-auto"><table className="w-full text-left text-sm"><thead className="bg-slate-50 text-slate-500"><tr><th className="p-2">User</th><th className="p-2">Time</th></tr></thead><tbody>{jobInterests.filter(ji => ji.jobId === viewingJobInterests).map(ji => (<tr key={ji.id} className="border-b"><td className="p-2 font-bold text-slate-700">{ji.userName}<br/><span className="text-xs text-slate-400 font-normal">{ji.userEmail}</span></td><td className="p-2 text-xs text-slate-500">{ji.clickedAt ? new Date(ji.clickedAt.seconds*1000).toLocaleString() : 'N/A'}</td></tr>))}{jobInterests.filter(ji => ji.jobId === viewingJobInterests).length === 0 && <tr><td colSpan={2} className="p-4 text-center text-slate-400">No views recorded yet.</td></tr>}</tbody></table></div><div className="mt-4 flex justify-end"><button onClick={() => exportToCSV(jobInterests.filter(ji => ji.jobId === viewingJobInterests), `job_viewers_${viewingJobInterests}`)} className="bg-green-600 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2"><FileSpreadsheet size={16}/> Export List</button></div></div>)}
                            {modalType === 'attendance_history' && studentForHistory && (<div><div className="flex items-center gap-4 mb-6"><div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-xl">{studentForHistory.name.charAt(0)}</div><div><h4 className="font-bold text-lg text-slate-800">{studentForHistory.name}</h4><p className="text-slate-500 text-sm">ID: {studentForHistory.studentId} | Batch: {studentForHistory.batch}</p></div></div><div className="bg-slate-50 rounded-xl p-4 border border-slate-100"><div className="grid grid-cols-2 md:grid-cols-4 gap-4">{studentForHistory.attendanceRecord && Object.entries(studentForHistory.attendanceRecord).sort().reverse().map(([date, status]) => (<div key={date} className="bg-white p-3 rounded-lg border border-slate-100 flex justify-between items-center shadow-sm"><span className="text-slate-600 text-xs font-bold">{date}</span><span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${status === 'Present' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{status}</span></div>))}{(!studentForHistory.attendanceRecord || Object.keys(studentForHistory.attendanceRecord).length === 0) && (<p className="col-span-4 text-center text-slate-400 py-4">No attendance records found.</p>)}</div></div><div className="mt-6 flex justify-end"><div className="text-sm font-bold text-slate-600">Attendance Rate: <span className="text-blue-600 text-lg">{studentForHistory.scores?.attendance || 0}%</span></div></div></div>)}
                            {modalType === 'create_blog' && (<div className="p-4"><h4 className="font-bold text-slate-800 mb-6 flex items-center gap-2 text-lg"><BookOpen size={20}/> {editingBlogId ? 'Edit Blog' : 'Write New Blog'}</h4><form onSubmit={handleSaveBlog} className="space-y-4"><input required placeholder="Blog Title" className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-purple-500 outline-none" value={newBlog.title} onChange={e=>setNewBlog({...newBlog, title: e.target.value})}/><input required placeholder="Author Name" className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-purple-500 outline-none" value={newBlog.author} onChange={e=>setNewBlog({...newBlog, author: e.target.value})}/><input required placeholder="Image URL" className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-purple-500 outline-none" value={newBlog.imageUrl} onChange={e=>setNewBlog({...newBlog, imageUrl: e.target.value})}/><textarea required placeholder="Short Excerpt..." className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-purple-500 outline-none h-20" value={newBlog.excerpt} onChange={e=>setNewBlog({...newBlog, excerpt: e.target.value})}/><textarea required placeholder="Full Content..." className="w-full p-3 rounded-xl bg-white border border-slate-200 text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-purple-500 outline-none h-40" value={newBlog.content || ''} onChange={e=>setNewBlog({...newBlog, content: e.target.value})}/><button className="w-full bg-purple-600 text-white font-bold py-3 rounded-xl hover:bg-purple-700 transition">{editingBlogId ? 'Update Blog' : 'Publish Blog'}</button></form></div>)}
                            
                            {/* --- MODIFIED MODALS WITH IMAGE UPLOAD --- */}

                            {/* 1. Manage Student Full (Ecosystem) */}
                            {modalType === 'manage_student_full' && manageStudent && 
                                <form onSubmit={(e) => { e.preventDefault(); handleGenericSave(updateEcosystemStudent(manageStudent.id!, studentEditForm), "Full Profile Updated"); }} className="space-y-8">
                                    <div className="flex gap-6 items-start">
                                        <div className="w-32 h-32 rounded-2xl bg-slate-200 overflow-hidden border-4 border-white shadow-lg shrink-0 relative group">
                                            {studentEditForm.photoURL || manageStudent.photoURL ? 
                                                <img src={studentEditForm.photoURL || manageStudent.photoURL} className="w-full h-full object-cover"/> : 
                                                <div className="w-full h-full flex items-center justify-center text-3xl font-bold text-slate-400">{manageStudent.name.charAt(0)}</div>
                                            }
                                            <label className="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                                                <Upload size={24} />
                                                <span className="text-[10px] font-bold mt-1">{uploadingPhoto ? 'Uploading...' : 'Change Photo'}</span>
                                                <input type="file" className="hidden" accept="image/*" onChange={(e) => handlePhotoUpload(e, setStudentEditForm, 'photoURL', studentEditForm)} />
                                            </label>
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 w-full">
                                            <div className="col-span-2 md:col-span-1"><label className="text-xs font-bold text-slate-500 uppercase">Full Name</label><input className="w-full p-2 border border-slate-200 bg-white rounded-lg font-bold text-slate-800" value={studentEditForm.name || manageStudent.name} onChange={e=>setStudentEditForm({...studentEditForm, name: e.target.value})}/></div>
                                            <div><label className="text-xs font-bold text-slate-500 uppercase">Student ID</label><input className="w-full p-2 border border-slate-200 bg-white rounded-lg font-mono text-blue-600 font-bold" value={studentEditForm.studentId || manageStudent.studentId || ''} onChange={e=>setStudentEditForm({...studentEditForm, studentId: e.target.value})}/></div>
                                            <div><label className="text-xs font-bold text-slate-500 uppercase">Status</label><select className="w-full p-2 border border-slate-200 bg-white rounded-lg font-bold" value={studentEditForm.status || manageStudent.status} onChange={e=>setStudentEditForm({...studentEditForm, status: e.target.value as any})}><option value="pending">Pending</option><option value="approved">Approved</option><option value="rejected">Rejected</option></select></div>
                                            <div><label className="text-xs font-bold text-slate-500 uppercase">Phone</label><input className="w-full p-2 border border-slate-200 bg-white rounded-lg" value={studentEditForm.phone || manageStudent.phone} onChange={e=>setStudentEditForm({...studentEditForm, phone: e.target.value})}/></div>
                                            <div className="col-span-2"><label className="text-xs font-bold text-slate-500 uppercase">Email</label><input className="w-full p-2 border border-slate-200 bg-white rounded-lg" value={studentEditForm.email || manageStudent.email} onChange={e=>setStudentEditForm({...studentEditForm, email: e.target.value})}/></div>
                                        </div>
                                    </div>
                                    <div className="h-px bg-slate-100 w-full"></div>
                                    <div><h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><BookOpen size={18} className="text-blue-600"/> Academic Progress</h4><div className="grid grid-cols-2 md:grid-cols-4 gap-4"><div><label className="text-xs font-bold text-slate-500 uppercase">Batch</label><input list="batches" className="w-full p-2 border border-slate-200 bg-white rounded-lg" value={studentEditForm.batch || manageStudent.batch || ''} onChange={e=>setStudentEditForm({...studentEditForm, batch: e.target.value})}/><datalist id="batches">{uniqueBatches.map(b=><option key={b} value={b}/>)}</datalist></div><div><label className="text-xs font-bold text-slate-500 uppercase">Current Module</label><input type="number" className="w-full p-2 border border-slate-200 bg-white rounded-lg" value={studentEditForm.currentModule ?? manageStudent.currentModule ?? 1} onChange={e => { const newModule = Number(e.target.value); const { due } = calculateFinancials(newModule, studentEditForm.totalPaid ?? manageStudent.totalPaid ?? 0); setStudentEditForm({ ...studentEditForm, currentModule: newModule, dueAmount: due }); }}/></div><div><label className="text-xs font-bold text-slate-500 uppercase">Phase</label><select className="w-full p-2 border border-slate-200 bg-white rounded-lg" value={studentEditForm.currentPhase || manageStudent.currentPhase || 'Learning'} onChange={e=>setStudentEditForm({...studentEditForm, currentPhase: e.target.value as any})}><option>Learning</option><option>Assessment</option><option>Internship</option></select></div><div><label className="text-xs font-bold text-slate-500 uppercase">Institution</label><input className="w-full p-2 border border-slate-200 bg-white rounded-lg" value={studentEditForm.institution || manageStudent.institution || ''} onChange={e=>setStudentEditForm({...studentEditForm, institution: e.target.value})}/></div></div></div>
                                    <div className="grid md:grid-cols-2 gap-8"><div className="bg-green-50 p-5 rounded-2xl border border-green-100"><h4 className="font-bold text-green-800 mb-4 flex items-center gap-2"><DollarSign size={18}/> Payment Info (BDT)</h4><div className="mb-4 bg-white/50 p-3 rounded-lg text-xs font-medium text-slate-600 space-y-1 border border-green-200"><div className="flex justify-between"><span>Admission:</span> <span>৳{ADMISSION_FEE}</span></div><div className="flex justify-between"><span>Module Fee (x{studentEditForm.currentModule ?? manageStudent.currentModule ?? 1}):</span> <span>৳{(studentEditForm.currentModule ?? manageStudent.currentModule ?? 1) * MODULE_FEE}</span></div><div className="flex justify-between border-t border-green-200 pt-1 font-bold text-green-700"><span>Total Payable:</span> <span>৳{calculateFinancials(studentEditForm.currentModule ?? manageStudent.currentModule ?? 1, 0).totalPayable}</span></div></div><div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-green-700 uppercase">Method</label><input className="w-full p-2 bg-white border border-green-200 rounded-lg" value={studentEditForm.paymentMethod || manageStudent.paymentMethod} onChange={e=>setStudentEditForm({...studentEditForm, paymentMethod: e.target.value as any})}/></div><div><label className="text-xs font-bold text-green-700 uppercase">TrxID</label><input className="w-full p-2 bg-white border border-green-200 rounded-lg font-mono" value={studentEditForm.transactionId || manageStudent.transactionId} onChange={e=>setStudentEditForm({...studentEditForm, transactionId: e.target.value})}/></div><div><label className="text-xs font-bold text-green-700 uppercase">Total Paid (৳)</label><input type="number" className="w-full p-2 bg-white border border-green-200 rounded-lg" value={studentEditForm.totalPaid ?? manageStudent.totalPaid ?? 0} onChange={e => { const newPaid = Number(e.target.value); const { due } = calculateFinancials(studentEditForm.currentModule ?? manageStudent.currentModule ?? 1, newPaid); setStudentEditForm({ ...studentEditForm, totalPaid: newPaid, dueAmount: due }); }}/></div><div><label className="text-xs font-bold text-green-700 uppercase">Due Amount (Auto)</label><input type="number" readOnly className="w-full p-2 bg-slate-100 border border-green-200 rounded-lg font-bold text-red-500 cursor-not-allowed" value={studentEditForm.dueAmount ?? manageStudent.dueAmount ?? 0} /></div></div></div><div className="bg-orange-50 p-5 rounded-2xl border border-orange-100"><h4 className="font-bold text-orange-800 mb-4 flex items-center gap-2"><Box size={18}/> Logistics & Internship</h4><div className="space-y-4"><div><label className="text-xs font-bold text-orange-700 uppercase">Kit Status</label><select className="w-full p-2 bg-white border border-orange-200 rounded-lg" value={studentEditForm.kitStatus || manageStudent.kitStatus} onChange={e=>setStudentEditForm({...studentEditForm, kitStatus: e.target.value as any})}><option>Pending</option><option>Processing</option><option>Shipped</option><option>Delivered</option></select></div><div><label className="text-xs font-bold text-orange-700 uppercase">Internship Company</label><input className="w-full p-2 bg-white border border-orange-200 rounded-lg" value={studentEditForm.assignedInternship?.companyName || manageStudent.assignedInternship?.companyName || ''} onChange={e=>setStudentEditForm({...studentEditForm, assignedInternship: {...(studentEditForm.assignedInternship || {} as any), companyName: e.target.value}})}/></div></div></div></div>
                                    <div><h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Award size={18} className="text-yellow-500"/> Performance Scores</h4><div className="grid grid-cols-3 md:grid-cols-6 gap-3">{['sales', 'communication', 'networking', 'eq', 'attendance', 'assignment'].map(field => (<div key={field}><label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">{field}</label><input type="number" className="w-full p-2 border border-slate-200 bg-white rounded-lg text-center font-bold" value={studentEditForm.scores?.[field as keyof typeof studentEditForm.scores] ?? manageStudent.scores?.[field as keyof typeof manageStudent.scores] ?? 0} onChange={e=> { const newScores = { ...(studentEditForm.scores || manageStudent.scores), [field]: Number(e.target.value) }; setStudentEditForm({...studentEditForm, scores: newScores as any}); }}/></div>))}</div></div>
                                    <div className="pt-4 flex gap-4"><button className="flex-1 bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-200 text-lg">Save All Changes</button><button type="button" onClick={()=>setIsModalOpen(false)} className="px-8 py-4 rounded-xl font-bold text-slate-600 hover:bg-slate-100 transition border border-slate-200">Cancel</button></div>
                                </form>
                            }

                            {/* 2. Manage Member (Affiliate/Ambassador) with Image Upload */}
                            {modalType === 'manage_member' && selectedMember && (
                                <div className="space-y-8">
                                    <div className="flex gap-6 items-start">
                                        <div className="w-24 h-24 rounded-full bg-slate-200 overflow-hidden border-4 border-white shadow-lg shrink-0 relative group">
                                            {memberEditForm.imageUrl || selectedMember.imageUrl ? 
                                                <img src={memberEditForm.imageUrl || selectedMember.imageUrl} className="w-full h-full object-cover"/> : 
                                                <div className="w-full h-full flex items-center justify-center text-3xl font-bold text-slate-400">{selectedMember.name.charAt(0)}</div>
                                            }
                                            <label className="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                                                <Upload size={20} />
                                                <span className="text-[8px] font-bold mt-1">{uploadingPhoto ? '...' : 'Photo'}</span>
                                                <input type="file" className="hidden" accept="image/*" onChange={(e) => handlePhotoUpload(e, setMemberEditForm, 'imageUrl', memberEditForm)} />
                                            </label>
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 w-full">
                                            <div><label className="text-xs font-bold text-slate-500 uppercase">Name</label><input className="w-full p-2 bg-white border rounded" value={memberEditForm.name || ''} onChange={e=>setMemberEditForm({...memberEditForm, name: e.target.value})}/></div>
                                            <div><label className="text-xs font-bold text-slate-500 uppercase">Phone</label><input className="w-full p-2 bg-white border rounded" value={memberEditForm.phone || ''} onChange={e=>setMemberEditForm({...memberEditForm, phone: e.target.value})}/></div>
                                            <div><label className="text-xs font-bold text-slate-500 uppercase">Institution</label><input className="w-full p-2 bg-white border rounded" value={memberEditForm.institution || ''} onChange={e=>setMemberEditForm({...memberEditForm, institution: e.target.value})}/></div>
                                            <div><label className="text-xs font-bold text-slate-500 uppercase">Type</label><select className="w-full p-2 bg-white border rounded" value={memberEditForm.type} onChange={e=>setMemberEditForm({...memberEditForm, type: e.target.value as any})}><option>Affiliate</option><option>Campus Ambassador</option></select></div>
                                            {selectedMember.type === 'Affiliate' && <div><label className="text-xs font-bold text-slate-500 uppercase">Referral Code</label><input className="w-full p-2 bg-white border rounded" value={memberEditForm.referralCode || ''} onChange={e=>setMemberEditForm({...memberEditForm, referralCode: e.target.value})}/></div>}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-4"><div className="bg-slate-50 p-4 rounded-xl text-center"><p className="text-xs text-slate-500 uppercase">Earnings</p><h3 className="text-2xl font-bold text-green-600">৳{selectedMember.totalEarnings || 0}</h3></div><div className="bg-slate-50 p-4 rounded-xl text-center"><p className="text-xs text-slate-500 uppercase">Referrals</p><h3 className="text-2xl font-bold text-blue-600">{selectedMember.referralCount || 0}</h3></div><div className="bg-slate-50 p-4 rounded-xl text-center"><p className="text-xs text-slate-500 uppercase">Status</p><select className="w-full mt-1 p-1 bg-white border rounded text-sm font-bold uppercase text-slate-800" value={memberEditForm.status || selectedMember.status} onChange={e => setMemberEditForm({ ...memberEditForm, status: e.target.value as any })}><option value="pending">Pending</option><option value="approved">Approved</option><option value="rejected">Rejected</option><option value="banned">Banned</option><option value="alumni">Alumni</option></select></div></div>{selectedMember.type === 'Affiliate' && (<div className="bg-white border border-slate-200 rounded-xl p-6"><h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><LayoutDashboard size={18}/> Withdrawal History</h4><div className="overflow-x-auto"><table className="w-full text-sm"><thead className="bg-slate-50"><tr><th className="p-2 text-left">Date</th><th className="p-2">Amount</th><th className="p-2">Method</th><th className="p-2">Status</th><th className="p-2">Action</th></tr></thead><tbody>{withdrawals.filter(w => w.userId === selectedMember.userId).map(w => (<tr key={w.id} className="border-b"><td className="p-2">{w.requestDate ? new Date(w.requestDate.seconds * 1000).toLocaleDateString() : 'N/A'}</td><td className="p-2 font-bold">৳{w.amount}</td><td className="p-2">{w.method}</td><td className="p-2"><span className={`px-2 py-0.5 rounded text-xs ${w.status==='paid'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}`}>{w.status}</span></td><td className="p-2">{w.status === 'pending' && <button onClick={()=>handleMarkPaid(w.id!)} className="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">Disburse</button>}</td></tr>))}{withdrawals.filter(w => w.userId === selectedMember.userId).length === 0 && <tr><td colSpan={5} className="p-4 text-center text-slate-400">No withdrawal history found.</td></tr>}</tbody></table></div></div>)}{selectedMember.type === 'Campus Ambassador' && (<div className="bg-white border border-slate-200 rounded-xl p-6"><h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><CheckSquare size={18}/> Assigned Tasks</h4><p className="text-slate-500 text-sm">Task submission history will appear here.</p></div>)}<div className="flex gap-4 pt-4"><button onClick={()=>handleGenericSave(updateAffiliateStatus(selectedMember.id!, memberEditForm.status || selectedMember.status, memberEditForm.referralCode), "Profile Updated")} className="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">Save Changes</button><button onClick={()=>setIsModalOpen(false)} className="px-6 py-3 border rounded-xl hover:bg-slate-50 font-bold">Close</button></div></div>
                            )}

                            {/* 3. Edit DB Member with Image Upload */}
                            {modalType === 'edit_db_member' && selectedDbMember && (
                                <div className="space-y-6">
                                    <div className="flex items-center gap-6">
                                        <div className="w-20 h-20 rounded-full bg-slate-100 overflow-hidden relative group shrink-0 border-2 border-slate-200">
                                            {dbMemberEditForm.imageUrl ? 
                                                <img src={dbMemberEditForm.imageUrl} className="w-full h-full object-cover"/> : 
                                                <div className="w-full h-full flex items-center justify-center text-slate-400 font-bold text-2xl">{dbMemberEditForm.name?.[0] || '?'}</div>
                                            }
                                            <label className="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                                                <Upload size={16} />
                                                <input type="file" className="hidden" accept="image/*" onChange={(e) => handlePhotoUpload(e, setDbMemberEditForm, 'imageUrl', dbMemberEditForm)} />
                                            </label>
                                        </div>
                                        <h4 className="font-bold text-slate-800 flex items-center gap-2 text-xl"><Edit size={20}/> Edit Member Details</h4>
                                    </div>
                                    
                                    <form onSubmit={handleSaveDbMember} className="grid md:grid-cols-2 gap-4">
                                        <div className="col-span-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Full Name</label>
                                            <input required className="w-full p-3 bg-white border rounded-xl" value={dbMemberEditForm.name || ''} onChange={e=>setDbMemberEditForm({...dbMemberEditForm, name: e.target.value})}/>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Phone</label>
                                            <input required className="w-full p-3 bg-white border rounded-xl" value={dbMemberEditForm.phone || ''} onChange={e=>setDbMemberEditForm({...dbMemberEditForm, phone: e.target.value})}/>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Email</label>
                                            <input className="w-full p-3 bg-white border rounded-xl" value={dbMemberEditForm.email || ''} onChange={e=>setDbMemberEditForm({...dbMemberEditForm, email: e.target.value})}/>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Role / Position</label>
                                            <input className="w-full p-3 bg-white border rounded-xl" value={dbMemberEditForm.role || ''} onChange={e=>setDbMemberEditForm({...dbMemberEditForm, role: e.target.value})}/>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Category</label>
                                            <select className="w-full p-3 border rounded-xl bg-white" value={dbMemberEditForm.category} onChange={e=>setDbMemberEditForm({...dbMemberEditForm, category: e.target.value})}>
                                                <option>Central</option>
                                                <option>Sub-Central</option>
                                                <option>Division Team</option>
                                                <option>District Team</option>
                                                <option>Campus Ambassador</option>
                                                <option>Volunteer</option>
                                                <option>Affiliate</option>
                                            </select>
                                        </div>
                                        <button className="col-span-2 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition mt-4">Save Changes</button>
                                    </form>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export default AdminDashboard;
